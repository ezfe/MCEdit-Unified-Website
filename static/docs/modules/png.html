<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>png &mdash; MCEdit-Unified v1.5.6.0 documentation</title>
    <meta name="description" content="">
    <meta name="author" content="">

    

<link rel="stylesheet" href="../static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" id="current-theme" href="../static/css/bootstrap3/bootswatch-yeti.css" type="text/css" />
<link rel="stylesheet" id="current-adjust-theme" href="../static/css/adjust_theme/bootswatch-yeti.css" type="text/css" />

<link rel="stylesheet" href="../static/css/font-awesome.min.css">

<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
</style>

<link rel="stylesheet" href="../static/css/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../',
            VERSION:     'v1.5.6.0',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
    <script type="text/javascript" src="../static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap3.min.js"></script>
<script type="text/javascript" src="../static/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../static/js/basicstrap.js"></script>
<script type="text/javascript">
</script>
    <link rel="shortcut icon" href="../static/favicon.ico"/>
    <link rel="top" title="MCEdit-Unified v1.5.6.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div id="navbar-top" class="navbar navbar-fixed-top navbar-default" role="navigation" aria-label="top navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">MCEdit-Unified v1.5.6.0 documentation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">

            
              <li><a href="../py-modindex.html" title="Python Module Index" >modules </a></li>
              <li><a href="../genindex.html" title="General Index" accesskey="I">index </a></li>
              <li><a href="index.html" accesskey="U">Module code</a></li>
            

            <li class="visible-xs">
                <form class="search form-search form-inline navbar-form navbar-right sp-searchbox" action="../search.html" method="get">
                  <div class="input-append input-group">
                    <input type="text" class="search-query form-control" name="q" placeholder="Search...">
                    <span class="input-group-btn">
                    <input type="submit" class="btn" value="Go" />
                    </span>
                  </div>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </li>

            

          </ul>

        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">

      <!-- row -->
      <div class="row">
         
<div class="col-md-3 hidden-xs" id="sidebar-wrapper">
  <div class="sidebar hidden-xs" role="navigation" aria-label="main navigation">
    <p class="logo"><a href="../index.html">
      <img class="logo" src="../static/favicon.png" alt="Logo"/>
    </a></p>
<div id="searchbox" role="search">
  <h3>Quick search</h3>
  <form class="search form-inline" action="../search.html" method="get">
      <div class="input-append input-group">
        <input type="text" class="search-query form-control" name="q" placeholder="Search...">
        <span class="input-group-btn">
        <input type="submit" class="btn" value="Go" />
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div> 
        

        <div class="col-md-9">
          <div class="document" role="main">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <h1>Source code for png</h1><div class="highlight"><pre>
<span class="c"># !/usr/bin/env python</span>

<span class="c"># $URL: http://pypng.googlecode.com/svn/trunk/code/png.py $</span>
<span class="c"># $Rev: 201 $</span>

<span class="c"># png.py - PNG encoder/decoder in pure Python</span>
<span class="c">#</span>
<span class="c"># Copyright (C) 2006 Johann C. Rocholl &lt;johann@browsershots.org&gt;</span>
<span class="c"># Portions Copyright (C) 2009 David Jones &lt;drj@pobox.com&gt;</span>
<span class="c"># And probably portions Copyright (C) 2006 Nicko van Someren &lt;nicko@nicko.org&gt;</span>
<span class="c">#</span>
<span class="c"># Original concept by Johann C. Rocholl.</span>
<span class="c">#</span>
<span class="c"># LICENSE (The MIT License)</span>
<span class="c">#</span>
<span class="c"># Permission is hereby granted, free of charge, to any person</span>
<span class="c"># obtaining a copy of this software and associated documentation files</span>
<span class="c"># (the &quot;Software&quot;), to deal in the Software without restriction,</span>
<span class="c"># including without limitation the rights to use, copy, modify, merge,</span>
<span class="c"># publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="c"># and to permit persons to whom the Software is furnished to do so,</span>
<span class="c"># subject to the following conditions:</span>
<span class="c">#</span>
<span class="c"># The above copyright notice and this permission notice shall be</span>
<span class="c"># included in all copies or substantial portions of the Software.</span>
<span class="c">#</span>
<span class="c"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="c"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="c"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="c"># NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="c"># BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="c"># ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="c"># CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c"># SOFTWARE.</span>
<span class="c">#</span>
<span class="c"># Changelog (recent first):</span>
<span class="c"># 2009-03-11 David: interlaced bit depth &lt; 8 (writing).</span>
<span class="c"># 2009-03-10 David: interlaced bit depth &lt; 8 (reading).</span>
<span class="c"># 2009-03-04 David: Flat and Boxed pixel formats.</span>
<span class="c"># 2009-02-26 David: Palette support (writing).</span>
<span class="c"># 2009-02-23 David: Bit-depths &lt; 8; better PNM support.</span>
<span class="c"># 2006-06-17 Nicko: Reworked into a class, faster interlacing.</span>
<span class="c"># 2006-06-17 Johann: Very simple prototype PNG decoder.</span>
<span class="c"># 2006-06-17 Nicko: Test suite with various image generators.</span>
<span class="c"># 2006-06-17 Nicko: Alpha-channel, grey-scale, 16-bit/plane support.</span>
<span class="c"># 2006-06-15 Johann: Scanline iterator interface for large input files.</span>
<span class="c"># 2006-06-09 Johann: Very simple prototype PNG encoder.</span>

<span class="c"># Incorporated into Bangai-O Development Tools by drj on 2009-02-11 from</span>
<span class="c"># http://trac.browsershots.org/browser/trunk/pypng/lib/png.py?rev=2885</span>

<span class="c"># Incorporated into pypng by drj on 2009-03-12 from</span>
<span class="c"># //depot/prj/bangaio/master/code/png.py#67</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Pure Python PNG Reader/Writer</span>

<span class="sd">This Python module implements support for PNG images (see PNG</span>
<span class="sd">specification at http://www.w3.org/TR/2003/REC-PNG-20031110/ ). It reads</span>
<span class="sd">and writes PNG files with all allowable bit depths (1/2/4/8/16/24/32/48/64</span>
<span class="sd">bits per pixel) and colour combinations: greyscale (1/2/4/8/16 bit); RGB,</span>
<span class="sd">RGBA, LA (greyscale with alpha) with 8/16 bits per channel; colour mapped</span>
<span class="sd">images (1/2/4/8 bit).  Adam7 interlacing is supported for reading and</span>
<span class="sd">writing.  A number of optional chunks can be specified (when writing)</span>
<span class="sd">and understood (when reading): ``tRNS``, ``bKGD``, ``gAMA``.</span>

<span class="sd">For help, type ``import png; help(png)`` in your python interpreter.</span>

<span class="sd">A good place to start is the :class:`Reader` and :class:`Writer` classes.</span>

<span class="sd">Requires Python 2.3.  Limited support is available for Python 2.2, but</span>
<span class="sd">not everything works.  Best with Python 2.4 and higher.  Installation is</span>
<span class="sd">trivial, but see the ``README.txt`` file (with the source distribution)</span>
<span class="sd">for details.</span>

<span class="sd">This file can also be used as a command-line utility to convert</span>
<span class="sd">`Netpbm &lt;http://netpbm.sourceforge.net/&gt;`_ PNM files to PNG, and the reverse conversion from PNG to</span>
<span class="sd">PNM. The interface is similar to that of the ``pnmtopng`` program from</span>
<span class="sd">Netpbm.  Type ``python png.py --help`` at the shell prompt</span>
<span class="sd">for usage and a list of options.</span>

<span class="sd">A note on spelling and terminology</span>
<span class="sd">----------------------------------</span>

<span class="sd">Generally British English spelling is used in the documentation.  So</span>
<span class="sd">that&#39;s &quot;greyscale&quot; and &quot;colour&quot;.  This not only matches the author&#39;s</span>
<span class="sd">native language, it&#39;s also used by the PNG specification.</span>

<span class="sd">The major colour models supported by PNG (and hence by PyPNG) are:</span>
<span class="sd">greyscale, RGB, greyscale--alpha, RGB--alpha.  These are sometimes</span>
<span class="sd">referred to using the abbreviations: L, RGB, LA, RGBA.  In this case</span>
<span class="sd">each letter abbreviates a single channel: *L* is for Luminance or Luma or</span>
<span class="sd">Lightness which is the channel used in greyscale images; *R*, *G*, *B* stand</span>
<span class="sd">for Red, Green, Blue, the components of a colour image; *A* stands for</span>
<span class="sd">Alpha, the opacity channel (used for transparency effects, but higher</span>
<span class="sd">values are more opaque, so it makes sense to call it opacity).</span>

<span class="sd">A note on formats</span>
<span class="sd">-----------------</span>

<span class="sd">When getting pixel data out of this module (reading) and presenting</span>
<span class="sd">data to this module (writing) there are a number of ways the data could</span>
<span class="sd">be represented as a Python value.  Generally this module uses one of</span>
<span class="sd">three formats called &quot;flat row flat pixel&quot;, &quot;boxed row flat pixel&quot;, and</span>
<span class="sd">&quot;boxed row boxed pixel&quot;.  Basically the concern is whether each pixel</span>
<span class="sd">and each row comes in its own little tuple (box), or not.</span>

<span class="sd">Consider an image that is 3 pixels wide by 2 pixels high, and each pixel</span>
<span class="sd">has RGB components:</span>

<span class="sd">Boxed row flat pixel::</span>

<span class="sd">    list([R,G,B, R,G,B, R,G,B],</span>
<span class="sd">        [R,G,B, R,G,B, R,G,B])</span>

<span class="sd">Each row appears as its own list, but the pixels are flattened so that</span>
<span class="sd">three values for one pixel simply follow the three values for the previous</span>
<span class="sd">pixel.  This is the most common format used, because it provides a good</span>
<span class="sd">compromise between space and convenience.  PyPNG regards itself as</span>
<span class="sd">at liberty to replace any sequence type with any sufficiently compatible</span>
<span class="sd">other sequence type; in practice each row is an array (from the array</span>
<span class="sd">module), and the outer list is sometimes an iterator rather than an</span>
<span class="sd">explicit list (so that streaming is possible).</span>

<span class="sd">Flat row flat pixel::</span>

<span class="sd">    [R,G,B, R,G,B, R,G,B,</span>
<span class="sd">    R,G,B, R,G,B, R,G,B]</span>

<span class="sd">The entire image is one single giant sequence of colour values.</span>
<span class="sd">Generally an array will be used (to save space), not a list.</span>

<span class="sd">Boxed row boxed pixel::</span>

<span class="sd">    list([ (R,G,B), (R,G,B), (R,G,B) ],</span>
<span class="sd">        [ (R,G,B), (R,G,B), (R,G,B) ])</span>

<span class="sd">Each row appears in its own list, but each pixel also appears in its own</span>
<span class="sd">tuple.  A serious memory burn in Python.</span>

<span class="sd">In all cases the top row comes first, and for each row the pixels are</span>
<span class="sd">ordered from left-to-right.  Within a pixel the values appear in the</span>
<span class="sd">order, R-G-B-A (or L-A for greyscale--alpha).</span>

<span class="sd">There is a fourth format, mentioned because it is used internally,</span>
<span class="sd">is close to what lies inside a PNG file itself, and has some support</span>
<span class="sd">from the public API.  This format is called packed.  When packed,</span>
<span class="sd">each row is a sequence of bytes (integers from 0 to 255), just as</span>
<span class="sd">it is before PNG scanline filtering is applied.  When the bit depth</span>
<span class="sd">is 8 this is essentially the same as boxed row flat pixel; when the</span>
<span class="sd">bit depth is less than 8, several pixels are packed into each byte;</span>
<span class="sd">when the bit depth is 16 (the only value more than 8 that is supported</span>
<span class="sd">by the PNG image format) each pixel value is decomposed into 2 bytes</span>
<span class="sd">(and `packed` is a misnomer).  This format is used by the</span>
<span class="sd">:meth:`Writer.write_packed` method.  It isn&#39;t usually a convenient</span>
<span class="sd">format, but may be just right if the source data for the PNG image</span>
<span class="sd">comes from something that uses a similar format (for example, 1-bit</span>
<span class="sd">BMPs, or another PNG file).</span>

<span class="sd">And now, my famous members</span>
<span class="sd">--------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># http://www.python.org/doc/2.2.3/whatsnew/node5.html</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">generators</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;$URL: http://pypng.googlecode.com/svn/trunk/code/png.py $ $Rev: 201 $&quot;</span>

<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>

<span class="k">try</span><span class="p">:</span>  <span class="c"># See :pyver:old</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="c"># http://www.python.org/doc/2.4.4/lib/module-operator.html</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="c"># http://www.python.org/doc/2.4.4/lib/module-warnings.html</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Reader&#39;</span><span class="p">,</span> <span class="s">&#39;Writer&#39;</span><span class="p">,</span> <span class="s">&#39;write_chunks&#39;</span><span class="p">]</span>

<span class="c"># The PNG signature.</span>
<span class="c"># http://www.w3.org/TR/PNG/#5PNG-file-signature</span>
<span class="n">_signature</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;8B&#39;</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">_adam7</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
          <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="c"># See</span>
    <span class="c"># http://www.python.org/doc/2.6/library/functions.html#zip</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">isarray</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Same as ``isinstance(x, array)`` except on Python 2.2, where it</span>
<span class="sd">    always returns ``False``.  This helps PyPNG work on Python 2.2.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">try</span><span class="p">:</span>  <span class="c"># see :pyver:old</span>
    <span class="n">array</span><span class="o">.</span><span class="n">tostring</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">B&#39;</span> <span class="o">%</span> <span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert row of bytes to string.  Expects `row` to be an</span>
<span class="sd">        ``array``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">interleave_planes</span><span class="p">(</span><span class="n">ipixels</span><span class="p">,</span> <span class="n">apixels</span><span class="p">,</span> <span class="n">ipsize</span><span class="p">,</span> <span class="n">apsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interleave (colour) planes, e.g. RGB + A = RGBA.</span>

<span class="sd">    Return an array of pixels consisting of the `ipsize` elements of data</span>
<span class="sd">    from each pixel in `ipixels` followed by the `apsize` elements of data</span>
<span class="sd">    from each pixel in `apixels`.  Conventionally `ipixels` and</span>
<span class="sd">    `apixels` are byte arrays so the sizes are bytes, but it actually</span>
<span class="sd">    works with any arrays of the same type.  The returned array is the</span>
<span class="sd">    same type as the input arrays which should be the same type as each other.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">itotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipixels</span><span class="p">)</span>
    <span class="n">atotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">apixels</span><span class="p">)</span>
    <span class="n">newtotal</span> <span class="o">=</span> <span class="n">itotal</span> <span class="o">+</span> <span class="n">atotal</span>
    <span class="n">newpsize</span> <span class="o">=</span> <span class="n">ipsize</span> <span class="o">+</span> <span class="n">apsize</span>
    <span class="c"># Set up the output buffer</span>
    <span class="c"># See http://www.python.org/doc/2.4.4/lib/module-array.html#l2h-1356</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">ipixels</span><span class="o">.</span><span class="n">typecode</span><span class="p">)</span>
    <span class="c"># It&#39;s annoying that there is no cheap way to set the array size :-(</span>
    <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ipixels</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">apixels</span><span class="p">)</span>
    <span class="c"># Interleave in the pixel data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ipsize</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">newtotal</span><span class="p">:</span><span class="n">newpsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipixels</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">itotal</span><span class="p">:</span><span class="n">ipsize</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">apsize</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ipsize</span><span class="p">:</span><span class="n">newtotal</span><span class="p">:</span><span class="n">newpsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">apixels</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">atotal</span><span class="p">:</span><span class="n">apsize</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">check_palette</span><span class="p">(</span><span class="n">palette</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check a palette argument (to the :class:`Writer` class) for validity.</span>
<span class="sd">    Returns the palette as a list if okay; raises an exception otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># None is the default and is allowed.</span>
    <span class="k">if</span> <span class="n">palette</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;a palette must have between 1 and 256 entries&quot;</span><span class="p">)</span>
    <span class="n">seen_triple</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;palette entry </span><span class="si">%d</span><span class="s">: entries must be 3- or 4-tuples.&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">seen_triple</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">seen_triple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;palette entry </span><span class="si">%d</span><span class="s">: all 4-tuples must precede all 3-tuples&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">x</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;palette entry </span><span class="si">%d</span><span class="s">: values must be integer: 0 &lt;= x &lt;= 255&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;Error&#39;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FormatError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Problem with input file format.  In other words, PNG file does</span>
<span class="sd">    not conform to the specification in some way and is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;FormatError&#39;</span>


<span class="k">class</span> <span class="nc">ChunkError</span><span class="p">(</span><span class="n">FormatError</span><span class="p">):</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;ChunkError&#39;</span>


<div class="viewcode-block" id="Writer"><a class="viewcode-back" href="../png.html#png.Writer">[docs]</a><span class="k">class</span> <span class="nc">Writer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PNG encoder in pure Python.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">greyscale</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">bitdepth</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                 <span class="n">palette</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">transparent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">background</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">gamma</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">compression</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">interlace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">bytes_per_sample</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="c"># deprecated</span>
                 <span class="n">planes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">colormap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">maxval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">chunk_limit</span><span class="o">=</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a PNG encoder object.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        width, height</span>
<span class="sd">          Image size in pixels, as two separate arguments.</span>
<span class="sd">        size</span>
<span class="sd">          Image size (w,h) in pixels, as single argument.</span>
<span class="sd">        greyscale</span>
<span class="sd">          Input data is greyscale, not RGB.</span>
<span class="sd">        alpha</span>
<span class="sd">          Input data has alpha channel (RGBA or LA).</span>
<span class="sd">        bitdepth</span>
<span class="sd">          Bit depth: from 1 to 16.</span>
<span class="sd">        palette</span>
<span class="sd">          Create a palette for a colour mapped image (colour type 3).</span>
<span class="sd">        transparent</span>
<span class="sd">          Specify a transparent colour (create a ``tRNS`` chunk).</span>
<span class="sd">        background</span>
<span class="sd">          Specify a default background colour (create a ``bKGD`` chunk).</span>
<span class="sd">        gamma</span>
<span class="sd">          Specify a gamma value (create a ``gAMA`` chunk).</span>
<span class="sd">        compression</span>
<span class="sd">          zlib compression level (1-9).</span>
<span class="sd">        interlace</span>
<span class="sd">          Create an interlaced image.</span>
<span class="sd">        chunk_limit</span>
<span class="sd">          Write multiple ``IDAT`` chunks to save memory.</span>

<span class="sd">        The image size (in pixels) can be specified either by using the</span>
<span class="sd">        `width` and `height` arguments, or with the single `size`</span>
<span class="sd">        argument.  If `size` is used it should be a pair (*width*,</span>
<span class="sd">        *height*).</span>

<span class="sd">        `greyscale` and `alpha` are booleans that specify whether</span>
<span class="sd">        an image is greyscale (or colour), and whether it has an</span>
<span class="sd">        alpha channel (or not).</span>

<span class="sd">        `bitdepth` specifies the bit depth of the source pixel values.</span>
<span class="sd">        Each source pixel values must be an integer between 0 and</span>
<span class="sd">        ``2**bitdepth-1``.  For example, 8-bit images have values</span>
<span class="sd">        between 0 and 255.  PNG only stores images with bit depths of</span>
<span class="sd">        1,2,4,8, or 16.  When `bitdepth` is not one of these values,</span>
<span class="sd">        the next highest valid bit depth is selected, and an ``sBIT``</span>
<span class="sd">        (significant bits) chunk is generated that specifies the original</span>
<span class="sd">        precision of the source image.  In this case the supplied pixel</span>
<span class="sd">        values will be rescaled to fit the range of the selected bit depth.</span>

<span class="sd">        The details of which bit depth / colour model combinations the</span>
<span class="sd">        PNG file format supports directly, are allowed are somewhat arcane</span>
<span class="sd">        (refer to the PNG specification for full details).  Briefly:</span>
<span class="sd">        &quot;small&quot; bit depths (1,2,4) are only allowed with greyscale and</span>
<span class="sd">        colour mapped images; colour mapped images cannot have bit depth</span>
<span class="sd">        16.</span>

<span class="sd">        For colour mapped images (in other words, when the `palette`</span>
<span class="sd">        argument is specified) the `bitdepth` argument must match one of</span>
<span class="sd">        the valid PNG bit depths: 1, 2, 4, or 8.  (It is valid to have a</span>
<span class="sd">        PNG image with a palette and an ``sBIT`` chunk, but the meaning</span>
<span class="sd">        is slightly different; it would be awkward to press the</span>
<span class="sd">        `bitdepth` argument into service for this.)</span>

<span class="sd">        The `palette` option, when specified, causes a colour mapped image</span>
<span class="sd">    to be created: the PNG colour type is set to 3; greyscale</span>
<span class="sd">    must not be set; alpha must not be set; transparent must</span>
<span class="sd">    not be set; the bit depth must be 1,2,4, or 8.  When a colour</span>
<span class="sd">        mapped image is created, the pixel values are palette indexes</span>
<span class="sd">        and the `bitdepth` argument specifies the size of these indexes</span>
<span class="sd">        (not the size of the colour values in the palette).</span>

<span class="sd">        The palette argument value should be a sequence of 3- or</span>
<span class="sd">        4-tuples.  3-tuples specify RGB palette entries; 4-tuples</span>
<span class="sd">        specify RGBA palette entries.  If both 4-tuples and 3-tuples</span>
<span class="sd">        appear in the sequence then all the 4-tuples must come</span>
<span class="sd">        before all the 3-tuples.  A ``PLTE`` chunk is created; if there</span>
<span class="sd">        are 4-tuples then a ``tRNS`` chunk is created as well.  The</span>
<span class="sd">        ``PLTE`` chunk will contain all the RGB triples in the same</span>
<span class="sd">        sequence; the ``tRNS`` chunk will contain the alpha channel for</span>
<span class="sd">        all the 4-tuples, in the same sequence.  Palette entries</span>
<span class="sd">        are always 8-bit.</span>

<span class="sd">        If specified, the `transparent` and `background` parameters must</span>
<span class="sd">        be a tuple with three integer values for red, green, blue, or</span>
<span class="sd">        a simple integer (or singleton tuple) for a greyscale image.</span>

<span class="sd">        If specified, the `gamma` parameter must be a positive number</span>
<span class="sd">        (generally, a float).  A ``gAMA`` chunk will be created.  Note that</span>
<span class="sd">        this will not change the values of the pixels as they appear in</span>
<span class="sd">        the PNG file, they are assumed to have already been converted</span>
<span class="sd">        appropriately for the gamma specified.</span>

<span class="sd">    The `compression` argument specifies the compression level</span>
<span class="sd">    to be used by the ``zlib`` module.  Higher values are likely</span>
<span class="sd">    to compress better, but will be slower to compress.  The</span>
<span class="sd">    default for this argument is ``None``; this does not mean</span>
<span class="sd">    no compression, rather it means that the default from the</span>
<span class="sd">    ``zlib`` module is used (which is generally acceptable).</span>

<span class="sd">        If `interlace` is true then an interlaced image is created</span>
<span class="sd">        (using PNG&#39;s so far only interace method, *Adam7*).  This does not</span>
<span class="sd">        affect how the pixels should be presented to the encoder, rather</span>
<span class="sd">        it changes how they are arranged into the PNG file.  On slow</span>
<span class="sd">        connexions interlaced images can be partially decoded by the</span>
<span class="sd">        browser to give a rough view of the image that is successively</span>
<span class="sd">        refined as more image data appears.</span>

<span class="sd">        .. note ::</span>

<span class="sd">          Enabling the `interlace` option requires the entire image</span>
<span class="sd">          to be processed in working memory.</span>

<span class="sd">        `chunk_limit` is used to limit the amount of memory used whilst</span>
<span class="sd">        compressing the image.  In order to avoid using large amounts of</span>
<span class="sd">        memory, multiple ``IDAT`` chunks may be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># At the moment the `planes` argument is ignored;</span>
        <span class="c"># its purpose is to act as a dummy so that</span>
        <span class="c"># ``Writer(x, y, **info)`` works, where `info` is a dictionary</span>
        <span class="c"># returned by Reader.read and friends.</span>
        <span class="c"># Ditto for `colormap`.</span>

        <span class="c"># A couple of helper functions come first.  Best skipped if you</span>
        <span class="c"># are reading through.</span>

        <span class="k">def</span> <span class="nf">isinteger</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">def</span> <span class="nf">check_color</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Checks that a colour argument for transparent or</span>
<span class="sd">            background options is the right form.  Also &quot;corrects&quot; bare</span>
<span class="sd">            integers to 1-tuples.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">greyscale</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> for greyscale must be 1-tuple&quot;</span> <span class="o">%</span>
                                     <span class="n">which</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isinteger</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s">&quot;</span><span class="si">%s</span><span class="s"> colour for greyscale must be integer&quot;</span> <span class="o">%</span>
                        <span class="n">which</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span>
                            <span class="n">isinteger</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span>
                            <span class="n">isinteger</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>
                            <span class="n">isinteger</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s">&quot;</span><span class="si">%s</span><span class="s"> colour must be a triple of integers&quot;</span> <span class="o">%</span>
                        <span class="n">which</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">c</span>

        <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;size argument should be a pair (width, height)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">!=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;size[0] (</span><span class="si">%r</span><span class="s">) and width (</span><span class="si">%r</span><span class="s">) should match when both are used.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">!=</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;size[1] (</span><span class="si">%r</span><span class="s">) and height (</span><span class="si">%r</span><span class="s">) should match when both are used.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">del</span> <span class="n">size</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;width and height must be greater than zero&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isinteger</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">isinteger</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;width and height must be integers&quot;</span><span class="p">)</span>
        <span class="c"># http://www.w3.org/TR/PNG/#7Integers-and-byte-order</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;width and height cannot exceed 2**32-1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">and</span> <span class="n">transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;transparent colour not allowed with alpha channel&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bytes_per_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;please use bitdepth instead of bytes_per_sample&#39;</span><span class="p">,</span>
                          <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bytes_per_sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;bytes per sample must be .125, .25, .5, 1, or 2&quot;</span><span class="p">)</span>
            <span class="n">bitdepth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">bytes_per_sample</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bytes_per_sample</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isinteger</span><span class="p">(</span><span class="n">bitdepth</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bitdepth</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">16</span> <span class="o">&lt;</span> <span class="n">bitdepth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;bitdepth (</span><span class="si">%r</span><span class="s">) must be a postive integer &lt;= 16&quot;</span> <span class="o">%</span>
                             <span class="n">bitdepth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">palette</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitdepth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;with palette, bitdepth must be 1, 2, 4, or 8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;transparent and palette not compatible&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;alpha and palette not compatible&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">greyscale</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;greyscale and palette not compatible&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># No palette, check for sBIT chunk generation.</span>
            <span class="k">if</span> <span class="n">alpha</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">greyscale</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bitdepth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                    <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">)[</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitdepth</span><span class="p">,</span> <span class="n">targetbitdepth</span><span class="p">)</span>
                    <span class="n">bitdepth</span> <span class="o">=</span> <span class="n">targetbitdepth</span>
                    <span class="k">del</span> <span class="n">targetbitdepth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">greyscale</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">alpha</span>
                <span class="k">if</span> <span class="n">bitdepth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                        <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="mi">16</span>
                    <span class="k">elif</span> <span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">bitdepth</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                        <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="mi">8</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitdepth</span><span class="p">,</span> <span class="n">targetbitdepth</span><span class="p">)</span>
                    <span class="n">bitdepth</span> <span class="o">=</span> <span class="n">targetbitdepth</span>
                    <span class="k">del</span> <span class="n">targetbitdepth</span>

        <span class="k">if</span> <span class="n">bitdepth</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="p">(</span><span class="n">alpha</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">greyscale</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">palette</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;bitdepth &lt; 8 only permitted with greyscale or palette&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">palette</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;bit depth must be 8 or less for images with palette&quot;</span><span class="p">)</span>

        <span class="n">transparent</span> <span class="o">=</span> <span class="n">check_color</span><span class="p">(</span><span class="n">transparent</span><span class="p">,</span> <span class="s">&#39;transparent&#39;</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">check_color</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="s">&#39;background&#39;</span><span class="p">)</span>

        <span class="c"># It&#39;s important that the true boolean values (greyscale, alpha,</span>
        <span class="c"># colormap, interlace) are converted to bool because Iverson&#39;s</span>
        <span class="c"># convention is relied upon later on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transparent</span> <span class="o">=</span> <span class="n">transparent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">greyscale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bitdepth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_limit</span> <span class="o">=</span> <span class="n">chunk_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">interlace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">palette</span> <span class="o">=</span> <span class="n">check_palette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="ow">not</span> <span class="n">greyscale</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="c"># :todo: fix for bitdepth &lt; 8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>

<div class="viewcode-block" id="Writer.make_palette"><a class="viewcode-back" href="../png.html#png.Writer.make_palette">[docs]</a>    <span class="k">def</span> <span class="nf">make_palette</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the byte sequences for a ``PLTE`` and if necessary a</span>
<span class="sd">        ``tRNS`` chunk.  Returned as a pair (*p*, *t*).  *t* will be</span>
<span class="sd">        ``None`` if no ``tRNS`` chunk is necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Writer.write"><a class="viewcode-back" href="../png.html#png.Writer.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a PNG image to the output file.  `rows` should be</span>
<span class="sd">        an iterable that yields each row in boxed row flat pixel format.</span>
<span class="sd">        The rows should be the rows of the original image, so there</span>
<span class="sd">        should be ``self.height`` rows of ``self.width * self.planes`` values.</span>
<span class="sd">        If `interlace` is specified (when creating the instance), then</span>
<span class="sd">        an interlaced PNG file will be written.  Supply the rows in the</span>
<span class="sd">        normal image order; the interlacing is carried out internally.</span>

<span class="sd">        .. note ::</span>

<span class="sd">          Interlacing will require the entire image to be in working memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrows</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;rows supplied (</span><span class="si">%d</span><span class="s">) does not match height (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Writer.write_passes"><a class="viewcode-back" href="../png.html#png.Writer.write_passes">[docs]</a>    <span class="k">def</span> <span class="nf">write_passes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">packed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a PNG image to the output file.</span>

<span class="sd">    Most users are expected to find the :meth:`write` or</span>
<span class="sd">    :meth:`write_array` method more convenient.</span>

<span class="sd">    The rows should be given to this method in the order that</span>
<span class="sd">    they appear in the output file.  For straightlaced images,</span>
<span class="sd">    this is the usual top to bottom ordering, but for interlaced</span>
<span class="sd">    images the rows should have already been interlaced before</span>
<span class="sd">    passing them to this function.</span>

<span class="sd">    `rows` should be an iterable that yields each row.  When</span>
<span class="sd">        `packed` is ``False`` the rows should be in boxed row flat pixel</span>
<span class="sd">        format; when `packed` is ``True`` each row should be a packed</span>
<span class="sd">        sequence of bytes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># http://www.w3.org/TR/PNG/#5PNG-file-signature</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_signature</span><span class="p">)</span>

        <span class="c"># http://www.w3.org/TR/PNG/#11IHDR</span>
        <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;IHDR&#39;</span><span class="p">,</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!2I5B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span><span class="p">,</span>
                                <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">))</span>

        <span class="c"># See :chunk:order</span>
        <span class="c"># http://www.w3.org/TR/PNG/#11gAMA</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;gAMA&#39;</span><span class="p">,</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!L&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="mf">1e5</span><span class="p">))))</span>

        <span class="c"># See :chunk:order</span>
        <span class="c"># http://www.w3.org/TR/PNG/#11sBIT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">:</span>
            <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;sBIT&#39;</span><span class="p">,</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">B&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span>
                                    <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">))</span>

        <span class="c"># :chunk:order: Without a palette (PLTE chunk), ordering is</span>
        <span class="c"># relatively relaxed.  With one, gAMA chunk must precede PLTE</span>
        <span class="c"># chunk which must precede tRNS and bKGD.</span>
        <span class="c"># See http://www.w3.org/TR/PNG/#5ChunkOrdering</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_palette</span><span class="p">()</span>
            <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;PLTE&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                <span class="c"># tRNS chunk is optional.  Only needed if palette entries</span>
                <span class="c"># have alpha.</span>
                <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;tRNS&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c"># http://www.w3.org/TR/PNG/#11tRNS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span><span class="p">:</span>
                <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;tRNS&#39;</span><span class="p">,</span>
                            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!1H&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">transparent</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;tRNS&#39;</span><span class="p">,</span>
                            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!3H&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">transparent</span><span class="p">))</span>

        <span class="c"># http://www.w3.org/TR/PNG/#11bKGD</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span><span class="p">:</span>
                <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;bKGD&#39;</span><span class="p">,</span>
                            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!1H&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;bKGD&#39;</span><span class="p">,</span>
                            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!3H&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">))</span>

        <span class="c"># http://www.w3.org/TR/PNG/#11IDAT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">compressor</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compressobj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compressor</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compressobj</span><span class="p">()</span>

        <span class="c"># Choose an extend function based on the bitdepth.  The extend</span>
        <span class="c"># function packs/decomposes the pixel values into bytes and</span>
        <span class="c"># stuffs them onto the data array.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">packed</span><span class="p">:</span>
            <span class="n">extend</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">extend</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="c"># Decompose into bytes</span>
            <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;!</span><span class="si">%d</span><span class="s">H&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">sl</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Pack into bytes</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&lt;</span> <span class="mi">8</span>
            <span class="c"># samples per byte</span>
            <span class="n">spb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">sl</span><span class="p">)</span>
                <span class="c"># Adding padding bytes so we can group into a whole</span>
                <span class="c"># number of spb-tuples.</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">spb</span><span class="p">))</span> <span class="o">*</span> <span class="n">spb</span> <span class="o">-</span> <span class="n">l</span>
                <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">extra</span><span class="p">))</span>
                <span class="c"># Pack into bytes</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">spb</span><span class="p">)</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span>
                                         <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">l</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">:</span>
            <span class="n">oldextend</span> <span class="o">=</span> <span class="n">extend</span>
            <span class="n">factor</span> <span class="o">=</span> \
                <span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">sl</span><span class="p">):</span>
                <span class="n">oldextend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="n">x</span><span class="p">)),</span> <span class="n">sl</span><span class="p">))</span>

        <span class="c"># Build the first row, testing mostly to see if we need to</span>
        <span class="c"># changed the extend function to cope with NumPy integer types</span>
        <span class="c"># (they cause our ordinary definition of extend to fail, so we</span>
        <span class="c"># wrap it).  See</span>
        <span class="c"># http://code.google.com/p/pypng/issues/detail?id=44</span>
        <span class="n">enumrows</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">rows</span>

        <span class="c"># First row&#39;s filter type.</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># :todo: Certain exceptions in the call to ``.next()`` or the</span>
        <span class="c"># following try would indicate no row data supplied.</span>
        <span class="c"># Should catch.</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">enumrows</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># If this fails...</span>
            <span class="n">extend</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># ... try a version that converts the values to int first.</span>
            <span class="c"># Not only does this work for the (slightly broken) NumPy</span>
            <span class="c"># types, there are probably lots of other, unknown, &quot;nearly&quot;</span>
            <span class="c"># int types it works for.</span>
            <span class="k">def</span> <span class="nf">wrapmapint</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">lambda</span> <span class="n">sl</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">sl</span><span class="p">))</span>

            <span class="n">extend</span> <span class="o">=</span> <span class="n">wrapmapint</span><span class="p">(</span><span class="n">extend</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">wrapmapint</span>
            <span class="n">extend</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">enumrows</span><span class="p">:</span>
            <span class="c"># Add &quot;None&quot; filter type.  Currently, it&#39;s essential that</span>
            <span class="c"># this filter type be used for every scanline as we do not</span>
            <span class="c"># mark the first row of a reduced pass image; that means we</span>
            <span class="c"># could accidentally compute the wrong filtered scanline if</span>
            <span class="c"># we used &quot;up&quot;, &quot;average&quot;, or &quot;paeth&quot; on such a line.</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">extend</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_limit</span><span class="p">:</span>
                <span class="n">compressed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">):</span>
                    <span class="c"># print &gt;&gt; sys.stderr, len(data), len(compressed)</span>
                    <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;IDAT&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="p">)</span>
                <span class="c"># Because of our very witty definition of ``extend``,</span>
                <span class="c"># above, we must re-use the same ``data`` object.  Hence</span>
                <span class="c"># we use ``del`` to empty this one, rather than create a</span>
                <span class="c"># fresh one (which would be my natural FP instinct).</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">flushed</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">flushed</span><span class="p">):</span>
            <span class="c"># print &gt;&gt; sys.stderr, len(data), len(compressed), len(flushed)</span>
            <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;IDAT&#39;</span><span class="p">,</span> <span class="n">compressed</span> <span class="o">+</span> <span class="n">flushed</span><span class="p">)</span>
        <span class="c"># http://www.w3.org/TR/PNG/#11IEND</span>
        <span class="n">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&#39;IEND&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Writer.write_array"><a class="viewcode-back" href="../png.html#png.Writer.write_array">[docs]</a>    <span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">pixels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an array in flat row flat pixel format as a PNG file on</span>
<span class="sd">        the output file.  See also :meth:`write` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_scanlines_interlace</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_scanlines</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Writer.write_packed"><a class="viewcode-back" href="../png.html#png.Writer.write_packed">[docs]</a>    <span class="k">def</span> <span class="nf">write_packed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write PNG file to `outfile`.  The pixel data comes from `rows`</span>
<span class="sd">        which should be in boxed row packed format.  Each row should be</span>
<span class="sd">        a sequence of packed bytes.</span>

<span class="sd">        Technically, this method does work for interlaced images but it</span>
<span class="sd">        is best avoided.  For interlaced images, the rows should be</span>
<span class="sd">        presented in the order that they appear in the file.</span>

<span class="sd">        This method should not be used when the source image bit depth</span>
<span class="sd">        is not one naturally supported by PNG; the bit depth should be</span>
<span class="sd">        1, 2, 4, 8, or 16.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;write_packed method not suitable for bit depth </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">packed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Writer.convert_pnm"><a class="viewcode-back" href="../png.html#png.Writer.convert_pnm">[docs]</a>    <span class="k">def</span> <span class="nf">convert_pnm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a PNM file containing raw pixel data into a PNG file</span>
<span class="sd">        with the parameters set in the writer object.  Works for</span>
<span class="sd">        (binary) PGM, PPM, and PAM formats.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">:</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">pixels</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span> <span class="o">*</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_scanlines_interlace</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_scanlines</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Writer.convert_ppm_and_pgm"><a class="viewcode-back" href="../png.html#png.Writer.convert_ppm_and_pgm">[docs]</a>    <span class="k">def</span> <span class="nf">convert_ppm_and_pgm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppmfile</span><span class="p">,</span> <span class="n">pgmfile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a PPM and PGM file containing raw pixel data into a</span>
<span class="sd">        PNG outfile with the parameters set in the writer object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">pixels</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">ppmfile</span><span class="p">,</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span> <span class="o">*</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">apixels</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">apixels</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">pgmfile</span><span class="p">,</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">interleave_planes</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">apixels</span><span class="p">,</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span><span class="p">,</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_scanlines_interlace</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_passes</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_scanlines</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Writer.file_scanlines"><a class="viewcode-back" href="../png.html#png.Writer.file_scanlines">[docs]</a>    <span class="k">def</span> <span class="nf">file_scanlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates boxed rows in flat pixel format, from the input file</span>
<span class="sd">        `infile`.  It assumes that the input file is in a &quot;Netpbm-like&quot;</span>
<span class="sd">        binary format, and is positioned at the beginning of the first</span>
<span class="sd">        pixel.  The number of pixels to read is taken from the image</span>
<span class="sd">        dimensions (`width`, `height`, `planes`) and the number of bytes</span>
<span class="sd">        per value is implied by the image `bitdepth`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Values per row</span>
        <span class="n">vpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>
        <span class="n">row_bytes</span> <span class="o">=</span> <span class="n">vpr</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">16</span>
            <span class="n">row_bytes</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;&gt;</span><span class="si">%d</span><span class="s">H&#39;</span> <span class="o">%</span> <span class="n">vpr</span>

            <span class="k">def</span> <span class="nf">line</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">row_bytes</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">line</span><span class="p">():</span>
                <span class="n">scanline</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">row_bytes</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">scanline</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">line</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Writer.array_scanlines"><a class="viewcode-back" href="../png.html#png.Writer.array_scanlines">[docs]</a>    <span class="k">def</span> <span class="nf">array_scanlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates boxed rows (flat pixels) from flat rows (flat pixels)</span>
<span class="sd">        in an array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Values per row</span>
        <span class="n">vpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">vpr</span>
            <span class="k">yield</span> <span class="n">pixels</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Writer.array_scanlines_interlace"><a class="viewcode-back" href="../png.html#png.Writer.array_scanlines_interlace">[docs]</a>    <span class="k">def</span> <span class="nf">array_scanlines_interlace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator for interlaced scanlines from an array.  `pixels` is</span>
<span class="sd">        the full source image in flat row flat pixel format.  The</span>
<span class="sd">        generator yields each scanline of the reduced passes in turn, in</span>
<span class="sd">        boxed row flat pixel format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># http://www.w3.org/TR/PNG/#8InterlaceMethods</span>
        <span class="c"># Array type.</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
        <span class="c"># Value per row</span>
        <span class="n">vpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>
        <span class="k">for</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">ystart</span><span class="p">,</span> <span class="n">xstep</span><span class="p">,</span> <span class="n">ystep</span> <span class="ow">in</span> <span class="n">_adam7</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xstart</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># Pixels per row (of reduced image)</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">xstart</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">xstep</span><span class="p">)))</span>
            <span class="c"># number of values in reduced image row.</span>
            <span class="n">row_len</span> <span class="o">=</span> <span class="n">ppr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ystart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">ystep</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">xstep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">vpr</span>
                    <span class="k">yield</span> <span class="n">pixels</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">vpr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
                    <span class="c"># There&#39;s no easier way to set the length of an array</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">row_len</span><span class="p">])</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">vpr</span> <span class="o">+</span> <span class="n">xstart</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>
                    <span class="n">end_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">vpr</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span> <span class="o">*</span> <span class="n">xstep</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">):</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">pixels</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span><span class="n">end_offset</span><span class="p">:</span><span class="n">skip</span><span class="p">]</span>
                    <span class="k">yield</span> <span class="n">row</span>

</div></div>
<span class="k">def</span> <span class="nf">write_chunk</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a PNG chunk to the output file, including length and</span>
<span class="sd">    checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># http://www.w3.org/TR/PNG/#5Chunk-layout</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!I&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">checksum</span><span class="p">)</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;!i&quot;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">))</span>


<div class="viewcode-block" id="write_chunks"><a class="viewcode-back" href="../png.html#png.write_chunks">[docs]</a><span class="k">def</span> <span class="nf">write_chunks</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a PNG file by writing out the chunks.&quot;&quot;&quot;</span>

    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_signature</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">write_chunk</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">chunk</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">filter_scanline</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">fo</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply a scanline filter to a scanline.  `type` specifies the</span>
<span class="sd">    filter type (0 to 4); `line` specifies the current (unfiltered)</span>
<span class="sd">    scanline as a sequence of bytes; `prev` specifies the previous</span>
<span class="sd">    (unfiltered) scanline as a sequence of bytes. `fo` specifies the</span>
<span class="sd">    filter offset; normally this is size of a pixel in bytes (the number</span>
<span class="sd">    of bytes per sample times the number of channels), but when this is</span>
<span class="sd">    &lt; 1 (for bit depths &lt; 8) then the filter offset is 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">type</span> <span class="o">&lt;</span> <span class="mi">5</span>

    <span class="c"># The output array.  Which, pathetically, we extend one-byte at a</span>
    <span class="c"># time (fortunately this is linear).</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">type</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">sub</span><span class="p">():</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="o">-</span><span class="n">fo</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ai</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">line</span><span class="p">[</span><span class="n">ai</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ai</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">average</span><span class="p">():</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="o">-</span><span class="n">fo</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ai</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">+</span> <span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ai</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">paeth</span><span class="p">():</span>
        <span class="c"># http://www.w3.org/TR/PNG/#9Filter-type-4-Paeth</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="o">-</span><span class="n">fo</span>  <span class="c"># also used for ci</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">ai</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pa</span> <span class="o">&lt;=</span> <span class="n">pb</span> <span class="ow">and</span> <span class="n">pa</span> <span class="o">&lt;=</span> <span class="n">pc</span><span class="p">:</span>
                <span class="n">Pr</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">elif</span> <span class="n">pb</span> <span class="o">&lt;=</span> <span class="n">pc</span><span class="p">:</span>
                <span class="n">Pr</span> <span class="o">=</span> <span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Pr</span> <span class="o">=</span> <span class="n">c</span>

            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">Pr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ai</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span><span class="p">:</span>
        <span class="c"># We&#39;re on the first line.  Some of the filters can be reduced</span>
        <span class="c"># to simpler cases which makes handling the line &quot;off the top&quot;</span>
        <span class="c"># of the image simpler.  &quot;up&quot; becomes &quot;none&quot;; &quot;paeth&quot; becomes</span>
        <span class="c"># &quot;left&quot; (non-trivial, but true). &quot;average&quot; needs to be handled</span>
        <span class="c"># specially.</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c"># &quot;up&quot;</span>
            <span class="k">return</span> <span class="n">line</span>  <span class="c"># type = 0</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c"># &quot;paeth&quot;</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sub</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">up</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">average</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c"># type == 4</span>
        <span class="n">paeth</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">_readable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple file-like interface for strings and arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">isarray</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">r</span>


<div class="viewcode-block" id="Reader"><a class="viewcode-back" href="../png.html#png.Reader">[docs]</a><span class="k">class</span> <span class="nc">Reader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PNG decoder in pure Python.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_guess</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a PNG decoder object.</span>

<span class="sd">        The constructor expects exactly one keyword argument. If you</span>
<span class="sd">        supply a positional argument instead, it will guess the input</span>
<span class="sd">        type. You can choose among the following keyword arguments:</span>

<span class="sd">        filename</span>
<span class="sd">          Name of input file (a PNG file).</span>
<span class="sd">        file</span>
<span class="sd">          A file-like object (object with a read() method).</span>
<span class="sd">        bytes</span>
<span class="sd">          ``array`` or ``string`` with PNG data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">_guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">_guess</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Reader() takes exactly 1 argument&quot;</span><span class="p">)</span>

        <span class="c"># Will be the first 8 bytes, later on.  See validate_signature.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transparent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># A pair of (len,type) if a chunk has been read but its data and</span>
        <span class="c"># checksum have not (in other words the file position is just</span>
        <span class="c"># past the 4 bytes that specify the chunk type).  See preamble</span>
        <span class="c"># method for how this is used.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">_guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isarray</span><span class="p">(</span><span class="n">_guess</span><span class="p">):</span>
                <span class="n">kw</span><span class="p">[</span><span class="s">&quot;bytes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_guess</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_guess</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                <span class="n">kw</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_guess</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_guess</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">):</span>
                <span class="n">kw</span><span class="p">[</span><span class="s">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_guess</span>

        <span class="k">if</span> <span class="s">&quot;filename&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">],</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&quot;file&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s">&quot;file&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&quot;bytes&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">_readable</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s">&quot;bytes&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;expecting filename, file or bytes array&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Reader.chunk"><a class="viewcode-back" href="../png.html#png.Reader.chunk">[docs]</a>    <span class="k">def</span> <span class="nf">chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seek</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the next PNG chunk from the input file; returns type (as a 4</span>
<span class="sd">        character string) and data.  If the optional `seek` argument is</span>
<span class="sd">        specified then it will keep reading chunks until it either runs</span>
<span class="sd">        out of file or finds the type specified by the argument.  Note</span>
<span class="sd">        that in general the order of chunks in PNGs is unspecified, so</span>
<span class="sd">        using `seek` can cause you to miss chunks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_signature</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c"># http://www.w3.org/TR/PNG/#5Chunk-layout</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunklentype</span><span class="p">()</span>
            <span class="n">length</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChunkError</span><span class="p">(</span><span class="s">&#39;Chunk </span><span class="si">%s</span><span class="s"> too short for required </span><span class="si">%i</span><span class="s"> octets.&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
            <span class="n">checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checksum</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Chunk </span><span class="si">%s</span><span class="s"> too short for checksum.&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seek</span> <span class="ow">and</span> <span class="nb">type</span> <span class="o">!=</span> <span class="n">seek</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">verify</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
            <span class="n">verify</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="p">)</span>
            <span class="c"># Whether the output from zlib.crc32 is signed or not varies</span>
            <span class="c"># according to hideous implementation details, see</span>
            <span class="c"># http://bugs.python.org/issue1202 .</span>
            <span class="c"># We coerce it to be positive here (in a way which works on</span>
            <span class="c"># Python 2.3 and older).</span>
            <span class="n">verify</span> <span class="o">&amp;=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">verify</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;!I&#39;</span><span class="p">,</span> <span class="n">verify</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checksum</span> <span class="o">!=</span> <span class="n">verify</span><span class="p">:</span>
                <span class="c"># print repr(checksum)</span>
                <span class="p">(</span><span class="n">a</span><span class="p">,)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!I&#39;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">)</span>
                <span class="p">(</span><span class="n">b</span><span class="p">,)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!I&#39;</span><span class="p">,</span> <span class="n">verify</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ChunkError</span><span class="p">(</span>
                    <span class="s">&quot;Checksum error in </span><span class="si">%s</span><span class="s"> chunk: 0x</span><span class="si">%08X</span><span class="s"> != 0x</span><span class="si">%08X</span><span class="s">.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">,</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="Reader.chunks"><a class="viewcode-back" href="../png.html#png.Reader.chunks">[docs]</a>    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator that will yield each chunk as a</span>
<span class="sd">        (*chunktype*, *content*) pair.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s">&#39;IEND&#39;</span><span class="p">:</span>
                <span class="k">break</span>
</div>
<div class="viewcode-block" id="Reader.undo_filter"><a class="viewcode-back" href="../png.html#png.Reader.undo_filter">[docs]</a>    <span class="k">def</span> <span class="nf">undo_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">,</span> <span class="n">scanline</span><span class="p">,</span> <span class="n">previous</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Undo the filter for a scanline.  `scanline` is a sequence of</span>
<span class="sd">        bytes that does not include the initial filter type byte.</span>
<span class="sd">        `previous` is decoded previous scanline (for straightlaced</span>
<span class="sd">        images this is the previous pixel row, but for interlaced</span>
<span class="sd">        images, it is the previous scanline in the reduced image, which</span>
<span class="sd">        in general is not the previous pixel row in the final image).</span>
<span class="sd">        When there is no previous scanline (the first row of a</span>
<span class="sd">        straightlaced image, or the first row in one of the passes in an</span>
<span class="sd">        interlaced image), then this argument should be ``None``.</span>

<span class="sd">        The scanline will have the effects of filtering removed, and the</span>
<span class="sd">        result will be returned as a fresh sequence of bytes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># :todo: Would it be better to update scanline in place?</span>

        <span class="c"># Create the result byte array.  It seems that the best way to</span>
        <span class="c"># create the array to be the right size is to copy from an</span>
        <span class="c"># existing sequence.  *sigh*</span>
        <span class="c"># If we fill the result with scanline, then this allows a</span>
        <span class="c"># micro-optimisation in the &quot;null&quot; and &quot;sub&quot; cases.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">scanline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># And here, we _rely_ on filling the result with scanline,</span>
            <span class="c"># above.</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">filter_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&#39;Invalid PNG Filter Type.&#39;</span>
                              <span class="s">&#39;  See http://www.w3.org/TR/2003/REC-PNG-20031110/#9Filters .&#39;</span><span class="p">)</span>

        <span class="c"># Filter unit.  The stride from one pixel to the corresponding</span>
        <span class="c"># byte from the previous previous.  Normally this is the pixel</span>
        <span class="c"># size in bytes, but when this is smaller than 1, the previous</span>
        <span class="c"># byte is used instead.</span>
        <span class="n">fu</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>

        <span class="c"># For the first line of a pass, synthesize a dummy previous</span>
        <span class="c"># line.  An alternative approach would be to observe that on the</span>
        <span class="c"># first line &#39;up&#39; is the same as &#39;null&#39;, &#39;paeth&#39; is the same</span>
        <span class="c"># as &#39;sub&#39;, with only &#39;average&#39; requiring any special case.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">previous</span><span class="p">:</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">scanline</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">sub</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Undo sub filter.&quot;&quot;&quot;</span>

            <span class="n">ai</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># Loops starts at index fu.  Observe that the initial part</span>
            <span class="c"># of the result is already filled in correctly with</span>
            <span class="c"># scanline.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fu</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">scanline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
                <span class="n">ai</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">up</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Undo up filter.&quot;&quot;&quot;</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">scanline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>

        <span class="k">def</span> <span class="nf">average</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Undo average filter.&quot;&quot;&quot;</span>

            <span class="n">ai</span> <span class="o">=</span> <span class="o">-</span><span class="n">fu</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">scanline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ai</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
                <span class="n">ai</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">paeth</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Undo Paeth filter.&quot;&quot;&quot;</span>

            <span class="c"># Also used for ci.</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="o">-</span><span class="n">fu</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">scanline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ai</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pa</span> <span class="o">&lt;=</span> <span class="n">pb</span> <span class="ow">and</span> <span class="n">pa</span> <span class="o">&lt;=</span> <span class="n">pc</span><span class="p">:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="n">a</span>
                <span class="k">elif</span> <span class="n">pb</span> <span class="o">&lt;=</span> <span class="n">pc</span><span class="p">:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">pr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
                <span class="n">ai</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Call appropriate filter algorithm.  Note that 0 has already</span>
        <span class="c"># been dealt with.</span>
        <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="n">paeth</span><span class="p">)[</span><span class="n">filter_type</span><span class="p">]()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="Reader.deinterlace"><a class="viewcode-back" href="../png.html#png.Reader.deinterlace">[docs]</a>    <span class="k">def</span> <span class="nf">deinterlace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read raw pixel data, undo filters, deinterlace, and flatten.</span>
<span class="sd">        Return in flat row flat pixel format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># print &gt;&gt; sys.stderr, (&quot;Reading interlaced, w=%s, r=%s, planes=%s,&quot; +</span>
        <span class="c">#     &quot; bpp=%s&quot;) % (self.width, self.height, self.planes, self.bps)</span>
        <span class="c"># Values per row (of the target image)</span>
        <span class="n">vpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>

        <span class="c"># Make a result array, and make it big enough.  Interleaving</span>
        <span class="c"># writes to the output array randomly (well, not quite), so the</span>
        <span class="c"># entire output array must be in memory.</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">vpr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">source_offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">ystart</span><span class="p">,</span> <span class="n">xstep</span><span class="p">,</span> <span class="n">ystep</span> <span class="ow">in</span> <span class="n">_adam7</span><span class="p">:</span>
            <span class="c"># print &gt;&gt; sys.stderr, &quot;Adam7: start=%s,%s step=%s,%s&quot; % (</span>
            <span class="c">#     xstart, ystart, xstep, ystep)</span>
            <span class="k">if</span> <span class="n">xstart</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># The previous (reconstructed) scanline.  None at the</span>
            <span class="c"># beginning of a pass to indicate that there is no previous</span>
            <span class="c"># line.</span>
            <span class="n">recon</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># Pixels per row (reduced pass image)</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">xstart</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">xstep</span><span class="p">)))</span>
            <span class="c"># Row size in bytes for this pass.</span>
            <span class="n">row_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="n">ppr</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ystart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">ystep</span><span class="p">):</span>
                <span class="n">filter_type</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">source_offset</span><span class="p">]</span>
                <span class="n">source_offset</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">scanline</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">source_offset</span><span class="p">:</span><span class="n">source_offset</span> <span class="o">+</span> <span class="n">row_size</span><span class="p">]</span>
                <span class="n">source_offset</span> <span class="o">+=</span> <span class="n">row_size</span>
                <span class="n">recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_filter</span><span class="p">(</span><span class="n">filter_type</span><span class="p">,</span> <span class="n">scanline</span><span class="p">,</span> <span class="n">recon</span><span class="p">)</span>
                <span class="c"># Convert so that there is one element per pixel value</span>
                <span class="n">flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialtoflat</span><span class="p">(</span><span class="n">recon</span><span class="p">,</span> <span class="n">ppr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">xstep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">xstart</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">vpr</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">vpr</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">vpr</span> <span class="o">+</span> <span class="n">xstart</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span>
                    <span class="n">end_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">vpr</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span> <span class="o">*</span> <span class="n">xstep</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">):</span>
                        <span class="n">a</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span><span class="n">end_offset</span><span class="p">:</span><span class="n">skip</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">a</span>
</div>
<div class="viewcode-block" id="Reader.iterboxed"><a class="viewcode-back" href="../png.html#png.Reader.iterboxed">[docs]</a>    <span class="k">def</span> <span class="nf">iterboxed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator that yields each scanline in boxed row flat pixel</span>
<span class="sd">        format.  `rows` should be an iterator that yields the bytes of</span>
<span class="sd">        each row in turn.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">asvalues</span><span class="p">(</span><span class="n">raw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Convert a row of raw bytes into a flat row.  Result may</span>
<span class="sd">            or may not share with argument&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">raw</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!</span><span class="si">%d</span><span class="s">H&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">raw</span><span class="p">))</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&lt;</span> <span class="mi">8</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
            <span class="c"># Samples per byte</span>
            <span class="n">spb</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="o">.</span><span class="n">__mul__</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">spb</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">o</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">),</span> <span class="n">shifts</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">asvalues</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Reader.serialtoflat"><a class="viewcode-back" href="../png.html#png.Reader.serialtoflat">[docs]</a>    <span class="k">def</span> <span class="nf">serialtoflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert serial format (byte stream) pixel data to flat row</span>
<span class="sd">        flat pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">tostring</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span>
                         <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!</span><span class="si">%d</span><span class="s">H&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&lt;</span> <span class="mi">8</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
        <span class="c"># Samples per byte</span>
        <span class="n">spb</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="o">.</span><span class="n">__mul__</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">spb</span><span class="p">)))</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">width</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">o</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">),</span> <span class="n">shifts</span><span class="p">)[:</span><span class="n">l</span><span class="p">])</span>
            <span class="n">l</span> <span class="o">-=</span> <span class="n">spb</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">width</span>
        <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="Reader.iterstraight"><a class="viewcode-back" href="../png.html#png.Reader.iterstraight">[docs]</a>    <span class="k">def</span> <span class="nf">iterstraight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator that undoes the effect of filtering, and yields each</span>
<span class="sd">        row in serialised format (as a sequence of bytes).  Assumes input</span>
<span class="sd">        is straightlaced.  `raw` should be an iterable that yields the</span>
<span class="sd">        raw bytes in chunks of arbitrary size.&quot;&quot;&quot;</span>

        <span class="c"># length of row, in bytes</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_bytes</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="c"># The previous (reconstructed) scanline.  None indicates first</span>
        <span class="c"># line of image.</span>
        <span class="n">recon</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">some</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">some</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">rb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">filter_type</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scanline</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">rb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">a</span><span class="p">[:</span><span class="n">rb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_filter</span><span class="p">(</span><span class="n">filter_type</span><span class="p">,</span> <span class="n">scanline</span><span class="p">,</span> <span class="n">recon</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">recon</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># :file:format We get here with a file format error: when the</span>
            <span class="c"># available bytes (after decompressing) do not pack into exact</span>
            <span class="c"># rows.</span>
            <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span>
                <span class="s">&#39;Wrong size for decompressed IDAT chunk.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Reader.validate_signature"><a class="viewcode-back" href="../png.html#png.Reader.validate_signature">[docs]</a>    <span class="k">def</span> <span class="nf">validate_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If signature (header) has not been read then read and</span>
<span class="sd">        validate it; otherwise do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">_signature</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;PNG file has invalid signature.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Reader.preamble"><a class="viewcode-back" href="../png.html#png.Reader.preamble">[docs]</a>    <span class="k">def</span> <span class="nf">preamble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the image metadata by reading the initial part of the PNG</span>
<span class="sd">        file up to the start of the ``IDAT`` chunk.  All the chunks that</span>
<span class="sd">        precede the ``IDAT`` chunk are read and either processed for</span>
<span class="sd">        metadata or discarded.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_signature</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunklentype</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span>
                        <span class="s">&#39;This PNG file has no IDAT chunks.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atchunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;IDAT&#39;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_chunk</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Reader.chunklentype"><a class="viewcode-back" href="../png.html#png.Reader.chunklentype">[docs]</a>    <span class="k">def</span> <span class="nf">chunklentype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads just enough of the input to determine the next</span>
<span class="sd">        chunk&#39;s length and type, returned as a (*length*, *type*) pair</span>
<span class="sd">        where *type* is a string.  If there are no more chunks, ``None``</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span>
                <span class="s">&#39;End of file whilst reading chunk length and type.&#39;</span><span class="p">)</span>
        <span class="n">length</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!I4s&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&#39;Chunk </span><span class="si">%s</span><span class="s"> is too large: </span><span class="si">%d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">length</span><span class="p">,</span> <span class="nb">type</span>
</div>
<div class="viewcode-block" id="Reader.process_chunk"><a class="viewcode-back" href="../png.html#png.Reader.process_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">process_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the next chunk and its data.  This only processes the</span>
<span class="sd">        following chunk types, all others are ignored: ``IHDR``,</span>
<span class="sd">        ``PLTE``, ``bKGD``, ``tRNS``, ``gAMA``, ``sBIT``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">type</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;IHDR&#39;</span><span class="p">:</span>
            <span class="c"># http://www.w3.org/TR/PNG/#11IHDR</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&#39;IHDR chunk has incorrect length.&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!2I5B&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="c"># Check that the header specifies only valid combinations.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;invalid bit depth </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;invalid colour type </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span><span class="p">)</span>
            <span class="c"># Check indexed (palettized) images have 8 or fewer bits</span>
            <span class="c"># per pixel; check only indexed or greyscale images have</span>
            <span class="c"># fewer than 8 bits per pixel.</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;Illegal combination of bit depth (</span><span class="si">%d</span><span class="s">)&quot;</span>
                                  <span class="s">&quot; and colour type (</span><span class="si">%d</span><span class="s">).&quot;</span>
                                  <span class="s">&quot; See http://www.w3.org/TR/2003/REC-PNG-20031110/#table111 .&quot;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;unknown compression method </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;Unknown filter method </span><span class="si">%d</span><span class="s">,&quot;</span>
                                  <span class="s">&quot; see http://www.w3.org/TR/2003/REC-PNG-20031110/#9Filters .&quot;</span>
                                  <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;Unknown interlace method </span><span class="si">%d</span><span class="s">,&quot;</span>
                                  <span class="s">&quot; see http://www.w3.org/TR/2003/REC-PNG-20031110/#8InterlaceMethods .&quot;</span>
                                  <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">)</span>

            <span class="c"># Derived values</span>
            <span class="c"># http://www.w3.org/TR/PNG/#6Colour-values</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">greyscale</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_type</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">color_planes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="n">greyscale</span> <span class="ow">or</span> <span class="n">colormap</span><span class="p">]</span>
            <span class="n">planes</span> <span class="o">=</span> <span class="n">color_planes</span> <span class="o">+</span> <span class="n">alpha</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="n">greyscale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span> <span class="o">=</span> <span class="n">color_planes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">planes</span> <span class="o">=</span> <span class="n">planes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">planes</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">))</span>
            <span class="c"># Stores PLTE chunk if present, and is used to check</span>
            <span class="c"># chunk ordering constraints.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plte</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># Stores tRNS chunk if present, and is used to check chunk</span>
            <span class="c"># ordering constraints.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trns</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># Stores sbit chunk if present.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;PLTE&#39;</span><span class="p">:</span>
            <span class="c"># http://www.w3.org/TR/PNG/#11PLTE</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Multiple PLTE chunks present.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plte</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span>
                    <span class="s">&quot;PLTE chunk&#39;s length should be a multiple of 3.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;PLTE chunk is too long.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;Empty PLTE is not allowed.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;bKGD&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s">&quot;PLTE chunk is required before bKGD chunk.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!</span><span class="si">%d</span><span class="s">H&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span><span class="p">,</span>
                                                    <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;bKGD chunk has incorrect length.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;tRNS&#39;</span><span class="p">:</span>
            <span class="c"># http://www.w3.org/TR/PNG/#11tRNS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trns</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;PLTE chunk is required before tRNS chunk.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c"># Was warning, but promoted to Error as it</span>
                        <span class="c"># would otherwise cause pain later on.</span>
                        <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;tRNS chunk is too long.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span>
                        <span class="s">&quot;tRNS chunk is not valid with colour type </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">color_type</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transparent</span> <span class="o">=</span> \
                        <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!</span><span class="si">%d</span><span class="s">H&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_planes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;tRNS chunk has incorrect length.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;gAMA&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;!L&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100000.0</span>
            <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;gAMA chunk has incorrect length.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;sBIT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sbit</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span><span class="s">&quot;sBIT chunk has incorrect length.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Reader.read"><a class="viewcode-back" href="../png.html#png.Reader.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the PNG file and decode it.  Returns (`width`, `height`,</span>
<span class="sd">        `pixels`, `metadata`).</span>

<span class="sd">        May use excessive memory.</span>

<span class="sd">        `pixels` are returned in boxed row flat pixel format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">iteridat</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Iterator that yields all the ``IDAT`` chunks as strings.&quot;&quot;&quot;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ChunkError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;IEND&#39;</span><span class="p">:</span>
                    <span class="c"># http://www.w3.org/TR/PNG/#11IEND</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s">&#39;IDAT&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c"># type == &#39;IDAT&#39;</span>
                <span class="c"># http://www.w3.org/TR/PNG/#11IDAT</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;PLTE chunk is required before IDAT chunk&quot;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">data</span>

        <span class="k">def</span> <span class="nf">iterdecomp</span><span class="p">(</span><span class="n">idat</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Iterator that yields decompressed strings.  `idat` should</span>
<span class="sd">            be an iterator that yields the ``IDAT`` chunk data.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c"># Currently, with no max_length paramter to decompress, this</span>
            <span class="c"># routine will do one yield per IDAT chunk.  So not very</span>
            <span class="c"># incremental.</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">()</span>
            <span class="c"># The decompression loop:</span>
            <span class="c"># Decompress an IDAT chunk, then decompress any remaining</span>
            <span class="c"># unused data until the unused data does not get any</span>
            <span class="c"># smaller.  Add the unused data to the front of the input</span>
            <span class="c"># and loop to process the next IDAT chunk.</span>
            <span class="n">cdata</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">idat</span><span class="p">:</span>
                <span class="c"># :todo: add a max_length argument here to limit output</span>
                <span class="c"># size.</span>
                <span class="k">yield</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">cdata</span> <span class="o">+</span> <span class="n">data</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span><span class="p">()</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">iterdecomp</span><span class="p">(</span><span class="n">iteridat</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interlace</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">))</span>
            <span class="n">arraycode</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
            <span class="c"># Like :meth:`group` but producing an array.array object for</span>
            <span class="c"># each row.</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">row</span><span class="p">:</span> <span class="n">array</span><span class="p">(</span><span class="n">arraycode</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                                    <span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deinterlace</span><span class="p">(</span><span class="n">raw</span><span class="p">))]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterboxed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterstraight</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="s">&#39;greyscale alpha planes bitdepth interlace&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">meta</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="s">&#39;gamma transparent background&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">meta</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span>
</div>
<div class="viewcode-block" id="Reader.read_flat"><a class="viewcode-back" href="../png.html#png.Reader.read_flat">[docs]</a>    <span class="k">def</span> <span class="nf">read_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a PNG file and decode it into flat row flat pixel format.</span>
<span class="sd">        Returns (*width*, *height*, *pixels*, *metadata*).</span>

<span class="sd">        May use excessive memory.</span>

<span class="sd">        `pixels` are returned in flat row flat pixel format.</span>

<span class="sd">        See also the :meth:`read` method which returns pixels in the</span>
<span class="sd">        more stream-friendly boxed row flat pixel format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">arraycode</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
        <span class="n">pixel</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">arraycode</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">pixel</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">meta</span>
</div>
<div class="viewcode-block" id="Reader.palette"><a class="viewcode-back" href="../png.html#png.Reader.palette">[docs]</a>    <span class="k">def</span> <span class="nf">palette</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="s">&#39;natural&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a palette that is a sequence of 3-tuples or 4-tuples,</span>
<span class="sd">        synthesizing it from the ``PLTE`` and ``tRNS`` chunks.  These</span>
<span class="sd">        chunks should have already been processed (for example, by</span>
<span class="sd">        calling the :meth:`preamble` method).  All the tuples are the</span>
<span class="sd">        same size, 3-tuples if there is no ``tRNS`` chunk, 4-tuples when</span>
<span class="sd">        there is a ``tRNS`` chunk.  Assumes that the image is colour type</span>
<span class="sd">        3 and therefore a ``PLTE`` chunk is required.</span>

<span class="sd">        If the `alpha` argument is ``&#39;force&#39;`` then an alpha channel is</span>
<span class="sd">        always added, forcing the result to be a sequence of 4-tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FormatError</span><span class="p">(</span>
                <span class="s">&quot;Required PLTE chunk is missing in colour type 3 image.&quot;</span><span class="p">)</span>
        <span class="n">plte</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plte</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trns</span> <span class="ow">or</span> <span class="n">alpha</span> <span class="o">==</span> <span class="s">&#39;force&#39;</span><span class="p">:</span>
            <span class="n">trns</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trns</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">trns</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">255</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plte</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">trns</span><span class="p">)))</span>
            <span class="n">plte</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">plte</span><span class="p">,</span> <span class="n">group</span><span class="p">(</span><span class="n">trns</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">plte</span>
</div>
<div class="viewcode-block" id="Reader.asDirect"><a class="viewcode-back" href="../png.html#png.Reader.asDirect">[docs]</a>    <span class="k">def</span> <span class="nf">asDirect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the image data as a direct representation of an</span>
<span class="sd">        ``x * y * planes`` array.  This method is intended to remove the</span>
<span class="sd">        need for callers to deal with palettes and transparency</span>
<span class="sd">        themselves.  Images with a palette (colour type 3)</span>
<span class="sd">        are converted to RGB or RGBA; images with transparency (a</span>
<span class="sd">        ``tRNS`` chunk) are converted to LA or RGBA as appropriate.</span>
<span class="sd">        When returned in this format the pixel values represent the</span>
<span class="sd">        colour value directly without needing to refer to palettes or</span>
<span class="sd">        transparency information.</span>

<span class="sd">        Like the :meth:`read` method this method returns a 4-tuple:</span>

<span class="sd">        (*width*, *height*, *pixels*, *meta*)</span>

<span class="sd">        This method normally returns pixel values with the bit depth</span>
<span class="sd">        they have in the source image, but when the source PNG has an</span>
<span class="sd">        ``sBIT`` chunk it is inspected and can reduce the bit depth of</span>
<span class="sd">        the result pixels; pixel values will be reduced according to</span>
<span class="sd">        the bit depth specified in the ``sBIT`` chunk (PNG nerds should</span>
<span class="sd">        note a single result bit depth is used for all channels; the</span>
<span class="sd">        maximum of the ones specified in the ``sBIT`` chunk.  An RGB565</span>
<span class="sd">        image will be rescaled to 6-bit RGB666).</span>

<span class="sd">        The *meta* dictionary that is returned reflects the `direct`</span>
<span class="sd">        format and not the original source image.  For example, an RGB</span>
<span class="sd">        source image with a ``tRNS`` chunk to represent a transparent</span>
<span class="sd">        colour, will have ``planes=3`` and ``alpha=False`` for the</span>
<span class="sd">        source image, but the *meta* dictionary returned by this method</span>
<span class="sd">        will have ``planes=4`` and ``alpha=True`` because an alpha</span>
<span class="sd">        channel is synthesized and added.</span>

<span class="sd">        *pixels* is the pixel data in boxed row flat pixel format (just</span>
<span class="sd">        like the :meth:`read` method).</span>

<span class="sd">        All the other aspects of the image data are not changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preamble</span><span class="p">()</span>

        <span class="c"># Simple case, no conversion necessary.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbit</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;colormap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trns</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;planes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trns</span><span class="p">)</span>
            <span class="n">plte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">iterpal</span><span class="p">(</span><span class="n">pixels</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">plte</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">))</span>

            <span class="n">pixels</span> <span class="o">=</span> <span class="n">iterpal</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trns</span><span class="p">:</span>
            <span class="c"># It would be nice if there was some reasonable way of doing</span>
            <span class="c"># this without generating a whole load of intermediate tuples.</span>
            <span class="c"># But tuples does seem like the easiest way, with no other way</span>
            <span class="c"># clearly much simpler or much faster.  (Actually, the L to LA</span>
            <span class="c"># conversion could perhaps go faster (all those 1-tuples!), but</span>
            <span class="c"># I still wonder whether the code proliferation is worth it)</span>
            <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transparent</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">planes</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;planes&#39;</span><span class="p">]</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;planes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">typecode</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">itertrns</span><span class="p">(</span><span class="n">pixels</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="c"># For each row we group it into pixels, then form a</span>
                    <span class="c"># characterisation vector that says whether each pixel</span>
                    <span class="c"># is opaque or not.  Then we convert True/False to</span>
                    <span class="c"># 0/maxval (by multiplication), and add it as the extra</span>
                    <span class="c"># channel.</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">planes</span><span class="p">)</span>
                    <span class="n">opa</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">__ne__</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                    <span class="n">opa</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">maxval</span><span class="o">.</span><span class="n">__mul__</span><span class="p">,</span> <span class="n">opa</span><span class="p">)</span>
                    <span class="n">opa</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">opa</span><span class="p">)</span>  <span class="c"># convert to 1-tuples</span>
                    <span class="k">yield</span> <span class="n">array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span>
                                <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">opa</span><span class="p">)))</span>

            <span class="n">pixels</span> <span class="o">=</span> <span class="n">itertrns</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
        <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbit</span><span class="p">:</span>
            <span class="n">sbit</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">B&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbit</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbit</span><span class="p">)</span>
            <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sbit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">targetbitdepth</span> <span class="o">&gt;</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;sBIT chunk </span><span class="si">%r</span><span class="s"> exceeds bitdepth </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">sbit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">sbit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;sBIT chunk </span><span class="si">%r</span><span class="s"> has a 0-entry&#39;</span> <span class="o">%</span> <span class="n">sbit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">targetbitdepth</span> <span class="o">==</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]:</span>
                <span class="n">targetbitdepth</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">targetbitdepth</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">targetbitdepth</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetbitdepth</span>

            <span class="k">def</span> <span class="nf">itershift</span><span class="p">(</span><span class="n">pixels</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="nb">map</span><span class="p">(</span><span class="n">shift</span><span class="o">.</span><span class="n">__rrshift__</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="n">pixels</span> <span class="o">=</span> <span class="n">itershift</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span>
</div>
<div class="viewcode-block" id="Reader.asFloat"><a class="viewcode-back" href="../png.html#png.Reader.asFloat">[docs]</a>    <span class="k">def</span> <span class="nf">asFloat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image pixels as per :meth:`asDirect` method, but scale</span>
<span class="sd">        all pixel values to be floating point values between 0.0 and</span>
<span class="sd">        *maxval*.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="n">sourcemaxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="s">&#39;maxval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">sourcemaxval</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">iterfloat</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">map</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">__mul__</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">iterfloat</span><span class="p">(),</span> <span class="n">info</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_as_rescale</span><span class="p">(</span><span class="n">get</span><span class="p">,</span> <span class="n">targetbitdepth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper used by :meth:`asRGB8` and :meth:`asRGBA8`.&quot;&quot;&quot;</span>

        <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">get</span><span class="p">()</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">targetmaxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">targetbitdepth</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">targetmaxval</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetbitdepth</span>

        <span class="k">def</span> <span class="nf">iterscale</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)),</span> <span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">iterscale</span><span class="p">(),</span> <span class="n">meta</span>

<div class="viewcode-block" id="Reader.asRGB8"><a class="viewcode-back" href="../png.html#png.Reader.asRGB8">[docs]</a>    <span class="k">def</span> <span class="nf">asRGB8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the image data as an RGB pixels with 8-bits per</span>
<span class="sd">    sample.  This is like the :meth:`asRGB` method except that</span>
<span class="sd">    this method additionally rescales the values so that they</span>
<span class="sd">    are all between 0 and 255 (8-bit).  In the case where the</span>
<span class="sd">    source image has a bit depth &lt; 8 the transformation preserves</span>
<span class="sd">    all the information; where the source image has bit depth</span>
<span class="sd">    &gt; 8, then rescaling to 8-bit values loses precision.  No</span>
<span class="sd">    dithering is performed.  Like :meth:`asRGB`, an alpha channel</span>
<span class="sd">    in the source image will raise an exception.</span>

<span class="sd">        This function returns a 4-tuple:</span>
<span class="sd">        (*width*, *height*, *pixels*, *metadata*).</span>
<span class="sd">        *width*, *height*, *metadata* are as per the :meth:`read` method.</span>

<span class="sd">        *pixels* is the pixel data in boxed row flat pixel format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_rescale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asRGB</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Reader.asRGBA8"><a class="viewcode-back" href="../png.html#png.Reader.asRGBA8">[docs]</a>    <span class="k">def</span> <span class="nf">asRGBA8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the image data as RGBA pixels with 8-bits per</span>
<span class="sd">        sample.  This method is similar to :meth:`asRGB8` and</span>
<span class="sd">        :meth:`asRGBA`:  The result pixels have an alpha channel, _and_</span>
<span class="sd">        values are rescale to the range 0 to 255.  The alpha channel is</span>
<span class="sd">        synthesized if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_rescale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asRGBA</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Reader.asRGB"><a class="viewcode-back" href="../png.html#png.Reader.asRGB">[docs]</a>    <span class="k">def</span> <span class="nf">asRGB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image as RGB pixels.  Greyscales are expanded into RGB</span>
<span class="sd">        triplets.  An alpha channel in the source image will raise an</span>
<span class="sd">        exception.  The return values are as for the :meth:`read` method</span>
<span class="sd">        except that the *metadata* reflect the returned pixels, not the</span>
<span class="sd">        source image.  In particular, for this method</span>
<span class="sd">        ``metadata[&#39;greyscale&#39;]`` will be ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;will not convert image with alpha channel to RGB&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">typecode</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">iterrgb</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">width</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">yield</span> <span class="n">a</span>

        <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">iterrgb</span><span class="p">(),</span> <span class="n">meta</span>
</div>
<div class="viewcode-block" id="Reader.asRGBA"><a class="viewcode-back" href="../png.html#png.Reader.asRGBA">[docs]</a>    <span class="k">def</span> <span class="nf">asRGBA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image as RGBA pixels.  Greyscales are expanded into</span>
<span class="sd">        RGB triplets; an alpha channel is synthesized if necessary.</span>
<span class="sd">        The return values are as for the :meth:`read` method</span>
<span class="sd">        except that the *metadata* reflect the returned pixels, not the</span>
<span class="sd">        source image.  In particular, for this method</span>
<span class="sd">        ``metadata[&#39;greyscale&#39;]`` will be ``False``, and</span>
<span class="sd">        ``metadata[&#39;alpha&#39;]`` will be ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span>
        <span class="n">typecode</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">newarray</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">width</span>

        <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]:</span>
            <span class="c"># LA to RGBA</span>
            <span class="k">def</span> <span class="nf">convert</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="c"># Create a fresh target row, then copy L channel</span>
                    <span class="c"># into first three target channels, and A channel</span>
                    <span class="c"># into fourth channel.</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">newarray</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">yield</span> <span class="n">a</span>
        <span class="k">elif</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]:</span>
            <span class="c"># L to RGBA</span>
            <span class="k">def</span> <span class="nf">convert</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">newarray</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
                    <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span>
                    <span class="k">yield</span> <span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]</span>

            <span class="c"># RGB to RGBA</span>
            <span class="k">def</span> <span class="nf">convert</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">newarray</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="p">[</span><span class="n">maxval</span><span class="p">])</span> <span class="o">*</span> <span class="n">width</span>
                    <span class="k">yield</span> <span class="n">a</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">convert</span><span class="p">(),</span> <span class="n">meta</span>


<span class="c"># === Legacy Version Support ===</span>

<span class="c"># :pyver:old:  PyPNG works on Python versions 2.3 and 2.2, but not</span>
<span class="c"># without some awkward problems.  Really PyPNG works on Python 2.4 (and</span>
<span class="c"># above); it works on Pythons 2.3 and 2.2 by virtue of fixing up</span>
<span class="c"># problems here.  It&#39;s a bit ugly (which is why it&#39;s hidden down here).</span>
<span class="c">#</span>
<span class="c"># Generally the strategy is one of pretending that we&#39;re running on</span>
<span class="c"># Python 2.4 (or above), and patching up the library support on earlier</span>
<span class="c"># versions so that it looks enough like Python 2.4.  When it comes to</span>
<span class="c"># Python 2.2 there is one thing we cannot patch: extended slices</span>
<span class="c"># http://www.python.org/doc/2.3/whatsnew/section-slices.html.</span>
<span class="c"># Instead we simply declare that features that are implemented using</span>
<span class="c"># extended slices will not work on Python 2.2.</span>
<span class="c">#</span>
<span class="c"># In order to work on Python 2.3 we fix up a recurring annoyance involving</span>
<span class="c"># the array type.  In Python 2.3 an array cannot be initialised with an</span>
<span class="c"># array, and it cannot be extended with a list (or other sequence).</span>
<span class="c"># Both of those are repeated issues in the code.  Whilst I would not</span>
<span class="c"># normally tolerate this sort of behaviour, here we &quot;shim&quot; a replacement</span>
<span class="c"># for array into place (and hope no-ones notices).  You never read this.</span>
<span class="c">#</span>
<span class="c"># In an amusing case of warty hacks on top of warty hacks... the array</span>
<span class="c"># shimming we try and do only works on Python 2.3 and above (you can&#39;t</span>
<span class="c"># subclass array.array in Python 2.2).  So to get it working on Python</span>
<span class="c"># 2.2 we go for something much simpler and (probably) way slower.</span></div></div>
<span class="k">try</span><span class="p">:</span>
    <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">([])</span>
    <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c"># Expect to get here on Python 2.3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">_array_shim</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
            <span class="n">true_array</span> <span class="o">=</span> <span class="n">array</span>

            <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
                <span class="n">super_new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_array_shim</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">super_new</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">typecode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">it</span>
                <span class="n">it</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">it</span>

            <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
                <span class="n">super_extend</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_array_shim</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_array</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">super_extend</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="c"># Convert to list.  Allows iterators to work.</span>
                    <span class="n">extension</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">super_extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typecode</span><span class="p">,</span> <span class="n">extension</span><span class="p">))</span>

        <span class="n">array</span> <span class="o">=</span> <span class="n">_array_shim</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># Expect to get here on Python 2.2</span>
        <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>

<span class="c"># Further hacks to get it limping along on Python 2.2</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">enumerate</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">reversed</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">reversed</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">x</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">itertools</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_dummy_itertools</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">itertools</span> <span class="o">=</span> <span class="n">_dummy_itertools</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_itertools_imap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">itertools</span><span class="o">.</span><span class="n">imap</span> <span class="o">=</span> <span class="n">_itertools_imap</span>

    <span class="k">def</span> <span class="nf">_itertools_chain</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">iterables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">element</span>

    <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">_itertools_chain</span>

<span class="c"># === Internal Test Support ===</span>

<span class="c"># This section comprises the tests that are internally validated (as</span>
<span class="c"># opposed to tests which produce output files that are externally</span>
<span class="c"># validated).  Primarily they are unittests.</span>

<span class="c"># Note that it is difficult to internally validate the results of</span>
<span class="c"># writing a PNG file.  The only thing we can do is read it back in</span>
<span class="c"># again, which merely checks consistency, not that the PNG file we</span>
<span class="c"># produce is valid.</span>

<span class="c"># Run the tests from the command line:</span>
<span class="c"># python -c &#39;import png;png.test()&#39;</span>

<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="c"># http://www.python.org/doc/2.4.4/lib/module-unittest.html</span>
<span class="kn">import</span> <span class="nn">unittest</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">topngbytes</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience function for creating a PNG file &quot;in memory&quot; as a</span>
<span class="sd">    string.  Creates a :class:`Writer` instance using the keyword arguments,</span>
<span class="sd">    then passes `rows` to its :meth:`Writer.write` method.  The resulting</span>
<span class="sd">    PNG file is returned as a string.  `name` is used to identify the file for</span>
<span class="sd">    debugging.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">print</span> <span class="n">name</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PYPNG_TEST_TMP&#39;</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">testWithIO</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls the function `f` with ``sys.stdin`` changed to `inp`</span>
<span class="sd">    and ``sys.stdout`` changed to `out`.  They are restored when `f`</span>
<span class="sd">    returns.  This function returns whatever `f` returns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oldin</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">inp</span>
        <span class="n">oldout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">out</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">oldin</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">oldout</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c"># This member is used by the superclass.  If we don&#39;t define a new</span>
    <span class="c"># class here then when we use self.assertRaises() and the PyPNG code</span>
    <span class="c"># raises an assertion then we get no proper traceback.  I can&#39;t work</span>
    <span class="c"># out why, but defining a new class here means we get a proper</span>
    <span class="c"># traceback.</span>
    <span class="k">class</span> <span class="nc">failureException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">helperLN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c"># Use small chunk_limit so that multiple chunk writing is</span>
        <span class="c"># tested.  Making it a test for Issue 20.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">chunk_limit</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">__and__</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">pixels</span><span class="p">)),</span>
                         <span class="nb">map</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">__and__</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">testL8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperLN</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testL4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperLN</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testL2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Also tests asRGB8.&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asRGB8</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pixels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="p">[</span><span class="mh">0x55</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testP2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;2-bit palette.&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asRGB8</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pixels</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">testPtrns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Test colour type 3 and tRNS chunk (and 4-bit palette).&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asRGBA8</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)</span>
        <span class="n">boxed</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">),</span> <span class="n">boxed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">pixels</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">flat</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">testRGBtoRGBA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;asRGBA8() on colour type 2 source.&quot;&quot;&quot;</span>
        <span class="c"># Test for Issue 26</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;basn2c08&#39;</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asRGBA8</span><span class="p">()</span>
        <span class="c"># Test the pixels at row 9 columns 0 and 1.</span>
        <span class="n">row9</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="mi">9</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">row9</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span>
                         <span class="p">[</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">testCtrns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Test colour type 2 and tRNS chunk.&quot;</span>
        <span class="c"># Test for Issue 25</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;tbrn2c08&#39;</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asRGBA8</span><span class="p">()</span>
        <span class="c"># I just happen to know that the first pixel is transparent.</span>
        <span class="c"># In particular it should be #7f7f7f00</span>
        <span class="n">row0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">testAdam7read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adam7 interlace reading.</span>
<span class="sd">        Specifically, test that for images in the PngSuite that</span>
<span class="sd">        have both an interlaced and straightlaced pair that both</span>
<span class="sd">        images from the pair produce the same array of pixels.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">_pngsuite</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;basn&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">candi</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">candi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_pngsuite</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span> <span class="s">&#39;adam7 read&#39;</span><span class="p">,</span> <span class="n">candidate</span>
            <span class="n">straight</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="n">candidate</span><span class="p">])</span>
            <span class="n">adam7</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="n">candi</span><span class="p">])</span>
            <span class="c"># Just compare the pixels.  Ignore x,y (because they&#39;re</span>
            <span class="c"># likely to be correct?); metadata is ignored because the</span>
            <span class="c"># &quot;interlace&quot; member differs.  Lame.</span>
            <span class="n">straight</span> <span class="o">=</span> <span class="n">straight</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">adam7</span> <span class="o">=</span> <span class="n">adam7</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">straight</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">adam7</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">testAdam7write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adam7 interlace writing.</span>
<span class="sd">        For each test image in the PngSuite, write an interlaced</span>
<span class="sd">        and a straightlaced version.  Decode both, and compare results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Not such a great test, because the only way we can check what</span>
        <span class="c"># we have written is to read it back again.</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="n">_pngsuite</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c"># Only certain colour types supported for this test.</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;n0&#39;</span><span class="p">,</span> <span class="s">&#39;n2&#39;</span><span class="p">,</span> <span class="s">&#39;n4&#39;</span><span class="p">,</span> <span class="s">&#39;n6&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">pngi</span> <span class="o">=</span> <span class="n">topngbytes</span><span class="p">(</span><span class="s">&#39;adam7wn&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span>
                              <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span>
                              <span class="n">greyscale</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                              <span class="n">transparent</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">transparent</span><span class="p">,</span>
                              <span class="n">interlace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">pngi</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">pngs</span> <span class="o">=</span> <span class="n">topngbytes</span><span class="p">(</span><span class="s">&#39;adam7wi&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span>
                              <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span>
                              <span class="n">greyscale</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">greyscale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                              <span class="n">transparent</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">transparent</span><span class="p">,</span>
                              <span class="n">interlace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">pngs</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ps</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">pi</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">testPGMin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that the command line tool can read PGM files.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">do</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_main</span><span class="p">([</span><span class="s">&#39;testPGMin&#39;</span><span class="p">])</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;P5 2 2 3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00\x01\x02\x03</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">testWithIO</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">do</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">greyscale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testPAMin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that the command line tool can read PAM file.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">do</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_main</span><span class="p">([</span><span class="s">&#39;testPAMin&#39;</span><span class="p">])</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;P7</span><span class="se">\n</span><span class="s">WIDTH 3</span><span class="se">\n</span><span class="s">HEIGHT 1</span><span class="se">\n</span><span class="s">DEPTH 4</span><span class="se">\n</span><span class="s">MAXVAL 255</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="s">&#39;TUPLTYPE RGB_ALPHA</span><span class="se">\n</span><span class="s">ENDHDR</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="c"># The pixels in flat row flat pixel format</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">flat</span><span class="p">)))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">testWithIO</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">do</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">greyscale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">pixels</span><span class="p">)),</span> <span class="n">flat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testLA4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an LA image with bitdepth 4.&quot;&quot;&quot;</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">topngbytes</span><span class="p">(</span><span class="s">&#39;la4.png&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">]],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">sbit</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="s">&#39;sBIT&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sbit</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\x04\x04</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testPNMsbit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that PNM files can generates sBIT chunk.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">do</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_main</span><span class="p">([</span><span class="s">&#39;testPNMsbit&#39;</span><span class="p">])</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;P6 8 1 1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pixel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x4081</span> <span class="o">*</span> <span class="n">pixel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10101</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">testWithIO</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">do</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">sbit</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="s">&#39;sBIT&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sbit</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\x01\x01\x01</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testLtrns0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create greyscale image with tRNS chunk.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperLtrns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testLtrns1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Using 1-tuple for transparent arg.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperLtrns</span><span class="p">((</span><span class="mi">0</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">helperLtrns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transparent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper used by :meth:`testLtrns*`.&quot;&quot;&quot;</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="s">&#39;00384c545c403800&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)))</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write_packed</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">pixels</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testWinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test the dictionary returned by a `read` method can be used</span>
<span class="sd">        as args for :meth:`Writer`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;basn2c16&#39;</span><span class="p">])</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">testPackedIter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test iterator for row when using write_packed.</span>

<span class="sd">        Indicative for Issue 47.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write_packed</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="mh">0x0a</span><span class="p">],</span> <span class="p">[</span><span class="mh">0xaa</span><span class="p">]),</span>
                           <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="mh">0x0f</span><span class="p">],</span> <span class="p">[</span><span class="mh">0xff</span><span class="p">])])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">16</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testInterlacedArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that reading an interlaced PNG yields each row as an</span>
<span class="sd">        array.&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;basi0g08&#39;</span><span class="p">])</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span>

    <span class="k">def</span> <span class="nf">testTrnsArray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that reading a type 2 PNG with tRNS chunk yields each</span>
<span class="sd">        row as an array (using asDirect).&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;tbrn2c08&#39;</span><span class="p">])</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span>

    <span class="c"># Invalid file format tests.  These construct various badly</span>
    <span class="c"># formatted PNG files, then feed them into a Reader.  When</span>
    <span class="c"># everything is working properly, we should get FormatError</span>
    <span class="c"># exceptions raised.</span>
    <span class="k">def</span> <span class="nf">testEmpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test empty file.&quot;&quot;&quot;</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FormatError</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testSigOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test file containing just signature bytes.&quot;&quot;&quot;</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_signature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FormatError</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testExtraPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test file that contains too many pixels.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">eachchunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;IDAT&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chunk</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;zip&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x00</span><span class="s">garbage&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;zip&#39;</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chunk</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FormatError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperFormat</span><span class="p">,</span> <span class="n">eachchunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testNotEnoughPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">eachchunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;IDAT&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chunk</span>
            <span class="c"># Remove last byte.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;zip&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;zip&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FormatError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperFormat</span><span class="p">,</span> <span class="n">eachchunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">helperFormat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;basn0g01&#39;</span><span class="p">])</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">newchunks</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">f</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="n">write_chunks</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">newchunks</span><span class="p">())</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">testBadFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">eachchunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;IDAT&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chunk</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;zip&#39;</span><span class="p">)</span>
            <span class="c"># Corrupt the first filter byte</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x99</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;zip&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">FormatError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">helperFormat</span><span class="p">,</span> <span class="n">eachchunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testFlat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test read_flat.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">hashlib</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="s">&#39;basn0g02&#39;</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_flat</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">pixel</span><span class="p">)))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">),</span> <span class="s">&#39;255cd971ab8cd9e7275ff906e5041aa0&#39;</span><span class="p">)</span>

    <span class="c"># numpy dependent tests.  These are skipped (with a message to</span>
    <span class="c"># sys.stderr) if numpy cannot be imported.</span>
    <span class="k">def</span> <span class="nf">testNumpyuint16</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy uint16.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;skipping numpy test&quot;</span>
            <span class="k">return</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">))]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">topngbytes</span><span class="p">(</span><span class="s">&#39;numpyuint16.png&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testNumpyuint8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy uint8.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;skipping numpy test&quot;</span>
            <span class="k">return</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">))]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">topngbytes</span><span class="p">(</span><span class="s">&#39;numpyuint8.png&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testNumpybool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy bool.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;skipping numpy test&quot;</span>
            <span class="k">return</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">topngbytes</span><span class="p">(</span><span class="s">&#39;numpybool.png&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">greyscale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="c"># === Command Line Support ===</span>


<span class="k">def</span> <span class="nf">_dehex</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Liberally convert from hex string to binary string.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="c"># Remove all non-hexadecimal digits</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[^a-fA-F\d]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)</span>

<span class="c"># Copies of PngSuite test files taken</span>
<span class="c"># from http://www.schaik.com/pngsuite/pngsuite_bas_png.html</span>
<span class="c"># on 2009-02-19 by drj and converted to hex.</span>
<span class="c"># Some of these are not actually in PngSuite (but maybe they should</span>
<span class="c"># be?), they use the same naming scheme, but start with a capital</span>
<span class="c"># letter.</span>
<span class="n">_pngsuite</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;basi0g01&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002001000000012c0677</span>
<span class="s">cf0000000467414d41000186a031e8965f0000009049444154789c2d8d310ec2</span>
<span class="s">300c45dfc682c415187a00a42e197ab81e83b127e00c5639001363a580d8582c</span>
<span class="s">65c910357c4b78b0bfbfdf4f70168c19e7acb970a3f2d1ded9695ce5bf5963df</span>
<span class="s">d92aaf4c9fd927ea449e6487df5b9c36e799b91bdf082b4d4bd4014fe4014b01</span>
<span class="s">ab7a17aee694d28d328a2d63837a70451e1648702d9a9ff4a11d2f7a51aa21e5</span>
<span class="s">a18c7ffd0094e3511d661822f20000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi0g02&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002002000000016ba60d</span>
<span class="s">1f0000000467414d41000186a031e8965f0000005149444154789c635062e860</span>
<span class="s">00e17286bb609c93c370ec189494960631366e4467b3ae675dcf10f521ea0303</span>
<span class="s">90c1ca006444e11643482064114a4852c710baea3f18c31918020c30410403a6</span>
<span class="s">0ac1a09239009c52804d85b6d97d0000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi0g04&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200400000001e4e6f8</span>
<span class="s">bf0000000467414d41000186a031e8965f000000ae49444154789c658e5111c2</span>
<span class="s">301044171c141c141c041c843a287510ea20d441c041c141c141c04191102454</span>
<span class="s">03994998cecd7edcecedbb9bdbc3b2c2b6457545fbc4bac1be437347f7c66a77</span>
<span class="s">3c23d60db15e88f5c5627338a5416c2e691a9b475a89cd27eda12895ae8dfdab</span>
<span class="s">43d61e590764f5c83a226b40d669bec307f93247701687723abf31ff83a2284b</span>
<span class="s">a5b4ae6b63ac6520ad730ca4ed7b06d20e030369bd6720ed383290360406d24e</span>
<span class="s">13811f2781eba9d34d07160000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi0g08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200800000001211615</span>
<span class="s">be0000000467414d41000186a031e8965f000000b549444154789cb5905d0ac2</span>
<span class="s">3010849dbac81c42c47bf843cf253e8878b0aa17110f214bdca6be240f5d21a5</span>
<span class="s">94ced3e49bcd322c1624115515154998aa424822a82a5624a1aa8a8b24c58f99</span>
<span class="s">999908130989a04a00d76c2c09e76cf21adcb209393a6553577da17140a2c59e</span>
<span class="s">70ecbfa388dff1f03b82fb82bd07f05f7cb13f80bb07ad2fd60c011c3c588eef</span>
<span class="s">f1f4e03bbec7ce832dca927aea005e431b625796345307b019c845e6bfc3bb98</span>
<span class="s">769d84f9efb02ea6c00f9bb9ff45e81f9f280000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi0g16&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002010000000017186c9</span>
<span class="s">fd0000000467414d41000186a031e8965f000000e249444154789cb5913b0ec2</span>
<span class="s">301044c7490aa8f85d81c3e4301c8f53a4ca0da8902c8144b3920b4043111282</span>
<span class="s">23bc4956681a6bf5fc3c5a3ba0448912d91a4de2c38dd8e380231eede4c4f7a1</span>
<span class="s">4677700bec7bd9b1d344689315a3418d1a6efbe5b8305ba01f8ff4808c063e26</span>
<span class="s">c60d5c81edcf6c58c535e252839e93801b15c0a70d810ae0d306b205dc32b187</span>
<span class="s">272b64057e4720ff0502154034831520154034c3df81400510cdf0015c86e5cc</span>
<span class="s">5c79c639fddba9dcb5456b51d7980eb52d8e7d7fa620a75120d6064641a05120</span>
<span class="s">b606771a05626b401a05f1f589827cf0fe44c1f0bae0055698ee8914fffffe00</span>
<span class="s">00000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi2c08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002008020000018b1fdd</span>
<span class="s">350000000467414d41000186a031e8965f000000f249444154789cd59341aa04</span>
<span class="s">210c44abc07b78133d59d37333bd89d76868b566d10cf4675af8596431a11662</span>
<span class="s">7c5688919280e312257dd6a0a4cf1a01008ee312a5f3c69c37e6fcc3f47e6776</span>
<span class="s">a07f8bdaf5b40feed2d33e025e2ff4fe2d4a63e1a16d91180b736d8bc45854c5</span>
<span class="s">6d951863f4a7e0b66dcf09a900f3ffa2948d4091e53ca86c048a64390f662b50</span>
<span class="s">4a999660ced906182b9a01a8be00a56404a6ede182b1223b4025e32c4de34304</span>
<span class="s">63457680c93aada6c99b73865aab2fc094920d901a203f5ddfe1970d28456783</span>
<span class="s">26cffbafeffcd30654f46d119be4793f827387fc0d189d5bc4d69a3c23d45a7f</span>
<span class="s">db803146578337df4d0a3121fc3d330000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi2c16&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000201002000001db8f01</span>
<span class="s">760000000467414d41000186a031e8965f0000020a49444154789cd5962173e3</span>
<span class="s">3010853fcf1838cc61a1818185a53e56787fa13fa130852e3b5878b4b0b03081</span>
<span class="s">b97f7030070b53e6b057a0a8912bbb9163b9f109ececbc59bd7dcf2b45492409</span>
<span class="s">d66f00eb1dd83cb5497d65456aeb8e1040913b3b2c04504c936dd5a9c7e2c6eb</span>
<span class="s">b1b8f17a58e8d043da56f06f0f9f62e5217b6ba3a1b76f6c9e99e8696a2a72e2</span>
<span class="s">c4fb1e4d452e92ec9652b807486d12b6669be00db38d9114b0c1961e375461a5</span>
<span class="s">5f76682a85c367ad6f682ff53a9c2a353191764b78bb07d8ddc3c97c1950f391</span>
<span class="s">6745c7b9852c73c2f212605a466a502705c8338069c8b9e84efab941eb393a97</span>
<span class="s">d4c9fd63148314209f1c1d3434e847ead6380de291d6f26a25c1ebb5047f5f24</span>
<span class="s">d85c49f0f22cc1d34282c72709cab90477bf25b89d49f0f351822297e0ea9704</span>
<span class="s">f34c82bc94002448ede51866e5656aef5d7c6a385cb4d80e6a538ceba04e6df2</span>
<span class="s">480e9aa84ddedb413bb5c97b3838456df2d4fec2c7a706983e7474d085fae820</span>
<span class="s">a841776a83073838973ac0413fea2f1dc4a06e71108fda73109bdae48954ad60</span>
<span class="s">bf867aac3ce44c7c1589a711cf8a81df9b219679d96d1cec3d8bbbeaa2012626</span>
<span class="s">df8c7802eda201b2d2e0239b409868171fc104ba8b76f10b4da09f6817ffc609</span>
<span class="s">c413ede267fd1fbab46880c90f80eccf0013185eb48b47ba03df2bdaadef3181</span>
<span class="s">cb8976f18e13188768170f98c0f844bb78cb04c62ddac59d09fc3fa25dfc1da4</span>
<span class="s">14deb3df1344f70000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi3p08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020080300000133a3ba</span>
<span class="s">500000000467414d41000186a031e8965f00000300504c5445224400f5ffed77</span>
<span class="s">ff77cbffff110a003a77002222ffff11ff110000222200ffac5566ff66ff6666</span>
<span class="s">ff01ff221200dcffffccff994444ff005555220000cbcbff44440055ff55cbcb</span>
<span class="s">00331a00ffecdcedffffe4ffcbffdcdc44ff446666ff330000442200ededff66</span>
<span class="s">6600ffa444ffffaaeded0000cbcbfefffffdfffeffff0133ff33552a000101ff</span>
<span class="s">8888ff00aaaa010100440000888800ffe4cbba5b0022ff22663200ffff99aaaa</span>
<span class="s">ff550000aaaa00cb630011ff11d4ffaa773a00ff4444dc6b0066000001ff0188</span>
<span class="s">4200ecffdc6bdc00ffdcba00333300ed00ed7300ffff88994a0011ffff770000</span>
<span class="s">ff8301ffbabafe7b00fffeff00cb00ff999922ffff880000ffff77008888ffdc</span>
<span class="s">ff1a33000000aa33ffff009900990000000001326600ffbaff44ffffffaaff00</span>
<span class="s">770000fefeaa00004a9900ffff66ff22220000998bff1155ffffff0101ff88ff</span>
<span class="s">005500001111fffffefffdfea4ff4466ffffff66ff003300ffff55ff77770000</span>
<span class="s">88ff44ff00110077ffff006666ffffed000100fff5ed1111ffffff44ff22ffff</span>
<span class="s">eded11110088ffff00007793ff2200dcdc3333fffe00febabaff99ffff333300</span>
<span class="s">63cb00baba00acff55ffffdcffff337bfe00ed00ed5555ffaaffffdcdcff5555</span>
<span class="s">00000066dcdc00dc00dc83ff017777fffefeffffffcbff5555777700fefe00cb</span>
<span class="s">00cb0000fe010200010000122200ffff220044449bff33ffd4aa0000559999ff</span>
<span class="s">999900ba00ba2a5500ffcbcbb4ff66ff9b33ffffbaaa00aa42880053aa00ffaa</span>
<span class="s">aa0000ed00babaffff1100fe00000044009999990099ffcc99ba000088008800</span>
<span class="s">dc00ff93220000dcfefffeaa5300770077020100cb0000000033ffedff00ba00</span>
<span class="s">ff3333edffedffc488bcff7700aa00660066002222dc0000ffcbffdcffdcff8b</span>
<span class="s">110000cb00010155005500880000002201ffffcbffcbed0000ff88884400445b</span>
<span class="s">ba00ffbc77ff99ff006600baffba00777773ed00fe00003300330000baff77ff</span>
<span class="s">004400aaffaafffefe000011220022c4ff8800eded99ff99ff55ff002200ffb4</span>
<span class="s">661100110a1100ff1111dcffbabaffff88ff88010001ff33ffb98ed362000002</span>
<span class="s">a249444154789c65d0695c0b001806f03711a9904a94d24dac63292949e5a810</span>
<span class="s">d244588a14ca5161d1a1323973252242d62157d12ae498c8124d25ca3a11398a</span>
<span class="s">16e55a3cdffab0ffe7f77d7fcff3528645349b584c3187824d9d19d4ec2e3523</span>
<span class="s">9eb0ae975cf8de02f2486d502191841b42967a1ad49e5ddc4265f69a899e26b5</span>
<span class="s">e9e468181baae3a71a41b95669da8df2ea3594c1b31046d7b17bfb86592e4cbe</span>
<span class="s">d89b23e8db0af6304d756e60a8f4ad378bdc2552ae5948df1d35b52143141533</span>
<span class="s">33bbbbababebeb3b3bc9c9c9c6c6c0c0d7b7b535323225a5aa8a02024a4bedec</span>
<span class="s">0a0a2a2bcdcd7d7cf2f3a9a9c9cdcdd8b8adcdd5b5ababa828298982824a4ab2</span>
<span class="s">b21212acadbdbc1414e2e24859b9a72730302f4f49292c4c57373c9c0a0b7372</span>
<span class="s">8c8c1c1c3a3a92936d6dfdfd293e3e26262a4a4eaea2424b4b5fbfbc9c323278</span>
<span class="s">3c0b0ba1303abaae8ecdeeed950d6669a9a7a7a141d4de9e9d5d5cdcd2229b94</span>
<span class="s">c572716132f97cb1d8db9bc3110864a39795d9db6b6a26267a7a9a98d4d6a6a7</span>
<span class="s">cb76090ef6f030354d4d75766e686030545464cb393a1a1ac6c68686eae8f8f9</span>
<span class="s">a9aa4644c8b66d6e1689dcdd2512a994cb35330b0991ad9f9b6b659596a6addd</span>
<span class="s">d8282fafae5e5323fb8f41d01f76c22fd8061be01bfc041a0323e1002c81cd30</span>
<span class="s">0b9ec027a0c930014ec035580fc3e112bc069a0b53e11c0c8095f00176c163a0</span>
<span class="s">e5301baec06a580677600ddc05ba0f13e120bc81a770133ec355a017300d4ec2</span>
<span class="s">0c7800bbe1219c02fa08f3e13c1c85dbb00a2ec05ea0dff00a6ec15a98027360</span>
<span class="s">070c047a06d7e1085c84f1b014f6c03fa0b33018b6c0211801ebe018fc00da0a</span>
<span class="s">6f61113c877eb01d4ec317a085700f26c130f80efbe132bc039a0733e106fc81</span>
<span class="s">f7f017f6c10aa0d1300a0ec374780943e1382c06fa0a9b60238c83473016cec0</span>
<span class="s">02f80f73fefe1072afc1e50000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basi6a08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200806000001047d4a</span>
<span class="s">620000000467414d41000186a031e8965f0000012049444154789cc595414ec3</span>
<span class="s">3010459fa541b8bbb26641b8069b861e8b4d12c1c112c1452a710a2a65d840d5</span>
<span class="s">949041fc481ec98ae27c7f3f8d27e3e4648047600fec0d1f390fbbe2633a31e2</span>
<span class="s">9389e4e4ea7bfdbf3d9a6b800ab89f1bd6b553cfcbb0679e960563d72e0a9293</span>
<span class="s">b7337b9f988cc67f5f0e186d20e808042f1c97054e1309da40d02d7e27f92e03</span>
<span class="s">6cbfc64df0fc3117a6210a1b6ad1a00df21c1abcf2a01944c7101b0cb568a001</span>
<span class="s">909c9cf9e399cf3d8d9d4660a875405d9a60d000b05e2de55e25780b7a5268e0</span>
<span class="s">622118e2399aab063a815808462f1ab86890fc2e03e48bb109ded7d26ce4bf59</span>
<span class="s">0db91bac0050747fec5015ce80da0e5700281be533f0ce6d5900b59bcb00ea6d</span>
<span class="s">200314cf801faab200ea752803a8d7a90c503a039f824a53f4694e7342000000</span>
<span class="s">0049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn0g01&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002001000000005b0147</span>
<span class="s">590000000467414d41000186a031e8965f0000005b49444154789c2dccb10903</span>
<span class="s">300c05d1ebd204b24a200b7a346f90153c82c18d0a61450751f1e08a2faaead2</span>
<span class="s">a4846ccea9255306e753345712e211b221bf4b263d1b427325255e8bdab29e6f</span>
<span class="s">6aca30692e9d29616ee96f3065f0bf1f1087492fd02f14c90000000049454e44</span>
<span class="s">ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn0g02&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002002000000001ca13d</span>
<span class="s">890000000467414d41000186a031e8965f0000001f49444154789c6360085df5</span>
<span class="s">1f8cf1308850c20053868f0133091f6390b90700bd497f818b0989a900000000</span>
<span class="s">49454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="c"># A version of basn0g04 dithered down to 3 bits.</span>
    <span class="s">&#39;Basn0g03&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020040000000093e1c8</span>
<span class="s">2900000001734249540371d88211000000fd49444154789c6d90d18906210c84</span>
<span class="s">c356f22356b2889588604301b112112b11d94a96bb495cf7fe87f32d996f2689</span>
<span class="s">44741cc658e39c0b118f883e1f63cc89dafbc04c0f619d7d898396c54b875517</span>
<span class="s">83f3a2e7ac09a2074430e7f497f00f1138a5444f82839c5206b1f51053cca968</span>
<span class="s">63258821e7f2b5438aac16fbecc052b646e709de45cf18996b29648508728612</span>
<span class="s">952ca606a73566d44612b876845e9a347084ea4868d2907ff06be4436c4b41a3</span>
<span class="s">a3e1774285614c5affb40dbd931a526619d9fa18e4c2be420858de1df0e69893</span>
<span class="s">a0e3e5523461be448561001042b7d4a15309ce2c57aef2ba89d1c13794a109d7</span>
<span class="s">b5880aa27744fc5c4aecb5e7bcef5fe528ec6293a930690000000049454e44ae</span>
<span class="s">426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn0g04&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020040000000093e1c8</span>
<span class="s">290000000467414d41000186a031e8965f0000004849444154789c6360601014</span>
<span class="s">545232367671090d4d4b2b2f6720430095dbd1418e002a77e64c720450b9ab56</span>
<span class="s">912380caddbd9b1c0154ee9933e408a072efde25470095fbee1d1902001f14ee</span>
<span class="s">01eaff41fa0000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn0g08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200800000000561125</span>
<span class="s">280000000467414d41000186a031e8965f0000004149444154789c6364602400</span>
<span class="s">1408c8b30c05058c0f0829f8f71f3f6079301c1430ca11906764a2795c0c0605</span>
<span class="s">8c8ff0cafeffcff887e67131181430cae0956564040050e5fe7135e2d8590000</span>
<span class="s">000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn0g16&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000200000002010000000000681f9</span>
<span class="s">6b0000000467414d41000186a031e8965f0000005e49444154789cd5d2310ac0</span>
<span class="s">300c4351395bef7fc6dca093c0287b32d52a04a3d98f3f3880a7b857131363a0</span>
<span class="s">3a82601d089900dd82f640ca04e816dc06422640b7a03d903201ba05b7819009</span>
<span class="s">d02d680fa44c603f6f07ec4ff41938cf7f0016d84bd85fae2b9fd70000000049</span>
<span class="s">454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn2c08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200802000000fc18ed</span>
<span class="s">a30000000467414d41000186a031e8965f0000004849444154789cedd5c10900</span>
<span class="s">300c024085ec91fdb772133b442bf4a1f8cee12bb40d043b800a14f81ca0ede4</span>
<span class="s">7d4c784081020f4a871fc284071428f0a0743823a94081bb7077a3c00182b1f9</span>
<span class="s">5e0f40cf4b0000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn2c16&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000201002000000ac8831</span>
<span class="s">e00000000467414d41000186a031e8965f000000e549444154789cd596c10a83</span>
<span class="s">301044a7e0417fcb7eb7fdadf6961e06039286266693cc7a188645e43dd6a08f</span>
<span class="s">1042003e2fe09aef6472737e183d27335fcee2f35a77b702ebce742870a23397</span>
<span class="s">f3edf2705dd10160f3b2815fe8ecf2027974a6b0c03f74a6e4192843e75c6c03</span>
<span class="s">35e8ec3202f5e84c0181bbe8cca967a00d9df3491bb040671f2e6087ce1c2860</span>
<span class="s">8d1e05f8c7ee0f1d00b667e70df44467ef26d01fbd9bc028f42860f71d188bce</span>
<span class="s">fb8d3630039dbd59601e7ab3c06cf428507f0634d039afdc80123a7bb1801e7a</span>
<span class="s">b1802a7a14c89f016d74ce331bf080ce9e08f8414f04bca133bfe642fe5e07bb</span>
<span class="s">c4ec0000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn6a08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200806000000737a7a</span>
<span class="s">f40000000467414d41000186a031e8965f0000006f49444154789cedd6310a80</span>
<span class="s">300c46e12764684fa1f73f55048f21c4ddc545781d52e85028fc1f4d28d98a01</span>
<span class="s">305e7b7e9cffba33831d75054703ca06a8f90d58a0074e351e227d805c8254e3</span>
<span class="s">1bb0420f5cdc2e0079208892ffe2a00136a07b4007943c1004d900195036407f</span>
<span class="s">011bf00052201a9c160fb84c0000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;cs3n3p08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020080300000044a48a</span>
<span class="s">c60000000467414d41000186a031e8965f0000000373424954030303a392a042</span>
<span class="s">00000054504c544592ff0000ff9200ffff00ff0000dbff00ff6dffb600006dff</span>
<span class="s">b6ff00ff9200dbff000049ffff2400ff000024ff0049ff0000ffdb00ff4900ff</span>
<span class="s">b6ffff0000ff2400b6ffffdb000092ffff6d000024ffff49006dff00df702b17</span>
<span class="s">0000004b49444154789c85cac70182000000b1b3625754b0edbfa72324ef7486</span>
<span class="s">184ed0177a437b680bcdd0031c0ed00ea21f74852ed00a1c9ed0086da0057487</span>
<span class="s">6ed0121cd6d004bda0013a421ff803224033e177f4ae260000000049454e44ae</span>
<span class="s">426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;s09n3p02&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d49484452000000090000000902030000009dffee</span>
<span class="s">830000000467414d41000186a031e8965f000000037342495404040477f8b5a3</span>
<span class="s">0000000c504c544500ff000077ffff00ffff7700ff5600640000001f49444154</span>
<span class="s">789c63600002fbff0c0c56ab19182ca381581a4283f82071200000696505c36a</span>
<span class="s">437f230000000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;tbgn3p08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020080300000044a48a</span>
<span class="s">c60000000467414d41000186a031e8965f00000207504c54457f7f7fafafafab</span>
<span class="s">abab110000222200737300999999510d00444400959500959595e6e600919191</span>
<span class="s">8d8d8d620d00898989666600b7b700911600000000730d007373736f6f6faaaa</span>
<span class="s">006b6b6b676767c41a00cccc0000f30000ef00d51e0055555567670000dd0051</span>
<span class="s">515100d1004d4d4de61e0038380000b700160d0d00ab00560d00090900009500</span>
<span class="s">009100008d003333332f2f2f2f2b2f2b2b000077007c7c001a05002b27000073</span>
<span class="s">002b2b2b006f00bb1600272727780d002323230055004d4d00cc1e00004d00cc</span>
<span class="s">1a000d00003c09006f6f00002f003811271111110d0d0d55554d090909001100</span>
<span class="s">4d0900050505000d00e2e200000900000500626200a6a6a6a2a2a29e9e9e8484</span>
<span class="s">00fb00fbd5d500801100800d00ea00ea555500a6a600e600e6f7f700e200e233</span>
<span class="s">0500888888d900d9848484c01a007777003c3c05c8c8008080804409007c7c7c</span>
<span class="s">bb00bbaa00aaa600a61e09056262629e009e9a009af322005e5e5e05050000ee</span>
<span class="s">005a5a5adddd00a616008d008d00e20016050027270088110078780000c40078</span>
<span class="s">00787300736f006f44444400aa00c81e004040406600663c3c3c090000550055</span>
<span class="s">1a1a00343434d91e000084004d004d007c004500453c3c00ea1e00222222113c</span>
<span class="s">113300331e1e1efb22001a1a1a004400afaf00270027003c001616161e001e0d</span>
<span class="s">160d2f2f00808000001e00d1d1001100110d000db7b7b7090009050005b3b3b3</span>
<span class="s">6d34c4230000000174524e530040e6d86600000001624b474402660b7c640000</span>
<span class="s">01f249444154789c6360c0048c8c58049100575f215ee92e6161ef109cd2a15e</span>
<span class="s">4b9645ce5d2c8f433aa4c24f3cbd4c98833b2314ab74a186f094b9c2c27571d2</span>
<span class="s">6a2a58e4253c5cda8559057a392363854db4d9d0641973660b0b0bb76bb16656</span>
<span class="s">06970997256877a07a95c75a1804b2fbcd128c80b482a0b0300f8a824276a9a8</span>
<span class="s">ec6e61612b3e57ee06fbf0009619d5fac846ac5c60ed20e754921625a2daadc6</span>
<span class="s">1967e29e97d2239c8aec7e61fdeca9cecebef54eb36c848517164514af16169e</span>
<span class="s">866444b2b0b7b55534c815cc2ec22d89cd1353800a8473100a4485852d924a6a</span>
<span class="s">412adc74e7ad1016ceed043267238c901716f633a812022998a4072267c4af02</span>
<span class="s">92127005c0f811b62830054935ce017b38bf0948cc5c09955f030a24617d9d46</span>
<span class="s">63371fd940b0827931cbfdf4956076ac018b592f72d45594a9b1f307f3261b1a</span>
<span class="s">084bc2ad50018b1900719ba6ba4ca325d0427d3f6161449486f981144cf3100e</span>
<span class="s">2a5f2a1ce8683e4ddf1b64275240c8438d98af0c729bbe07982b8a1c94201dc2</span>
<span class="s">b3174c9820bcc06201585ad81b25b64a2146384e3798290c05ad280a18c0a62e</span>
<span class="s">e898260c07fca80a24c076cc864b777131a00190cdfa3069035eccbc038c30e1</span>
<span class="s">3e88b46d16b6acc5380d6ac202511c392f4b789aa7b0b08718765990111606c2</span>
<span class="s">9e854c38e5191878fbe471e749b0112bb18902008dc473b2b2e8e72700000000</span>
<span class="s">49454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;Tp2n3p08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020080300000044a48a</span>
<span class="s">c60000000467414d41000186a031e8965f00000300504c544502ffff80ff05ff</span>
<span class="s">7f0703ff7f0180ff04ff00ffff06ff000880ff05ff7f07ffff06ff000804ff00</span>
<span class="s">0180ff02ffff03ff7f02ffff80ff0503ff7f0180ffff0008ff7f0704ff00ffff</span>
<span class="s">06ff000802ffffff7f0704ff0003ff7fffff0680ff050180ff04ff000180ffff</span>
<span class="s">0008ffff0603ff7f80ff05ff7f0702ffffff000880ff05ffff0603ff7f02ffff</span>
<span class="s">ff7f070180ff04ff00ffff06ff000880ff050180ffff7f0702ffff04ff0003ff</span>
<span class="s">7fff7f0704ff0003ff7f0180ffffff06ff000880ff0502ffffffff0603ff7fff</span>
<span class="s">7f0702ffff04ff000180ff80ff05ff0008ff7f07ffff0680ff0504ff00ff0008</span>
<span class="s">0180ff03ff7f02ffff02ffffffff0604ff0003ff7f0180ffff000880ff05ff7f</span>
<span class="s">0780ff05ff00080180ff02ffffff7f0703ff7fffff0604ff00ff7f07ff0008ff</span>
<span class="s">ff0680ff0504ff0002ffff0180ff03ff7fff0008ffff0680ff0504ff000180ff</span>
<span class="s">02ffff03ff7fff7f070180ff02ffff04ff00ffff06ff0008ff7f0780ff0503ff</span>
<span class="s">7fffff06ff0008ff7f0780ff0502ffff03ff7f0180ff04ff0002ffffff7f07ff</span>
<span class="s">ff0604ff0003ff7fff00080180ff80ff05ffff0603ff7f0180ffff000804ff00</span>
<span class="s">80ff0502ffffff7f0780ff05ffff0604ff000180ffff000802ffffff7f0703ff</span>
<span class="s">7fff0008ff7f070180ff03ff7f02ffff80ff05ffff0604ff00ff0008ffff0602</span>
<span class="s">ffff0180ff04ff0003ff7f80ff05ff7f070180ff04ff00ff7f0780ff0502ffff</span>
<span class="s">ff000803ff7fffff0602ffffff7f07ffff0680ff05ff000804ff0003ff7f0180</span>
<span class="s">ff02ffff0180ffff7f0703ff7fff000804ff0080ff05ffff0602ffff04ff00ff</span>
<span class="s">ff0603ff7fff7f070180ff80ff05ff000803ff7f0180ffff7f0702ffffff0008</span>
<span class="s">04ff00ffff0680ff0503ff7f0180ff04ff0080ff05ffff06ff000802ffffff7f</span>
<span class="s">0780ff05ff0008ff7f070180ff03ff7f04ff0002ffffffff0604ff00ff7f07ff</span>
<span class="s">000880ff05ffff060180ff02ffff03ff7f80ff05ffff0602ffff0180ff03ff7f</span>
<span class="s">04ff00ff7f07ff00080180ffff000880ff0502ffff04ff00ff7f0703ff7fffff</span>
<span class="s">06ff0008ffff0604ff00ff7f0780ff0502ffff03ff7f0180ffdeb83387000000</span>
<span class="s">f874524e53000000000000000008080808080808081010101010101010181818</span>
<span class="s">1818181818202020202020202029292929292929293131313131313131393939</span>
<span class="s">393939393941414141414141414a4a4a4a4a4a4a4a52525252525252525a5a5a</span>
<span class="s">5a5a5a5a5a62626262626262626a6a6a6a6a6a6a6a73737373737373737b7b7b</span>
<span class="s">7b7b7b7b7b83838383838383838b8b8b8b8b8b8b8b94949494949494949c9c9c</span>
<span class="s">9c9c9c9c9ca4a4a4a4a4a4a4a4acacacacacacacacb4b4b4b4b4b4b4b4bdbdbd</span>
<span class="s">bdbdbdbdbdc5c5c5c5c5c5c5c5cdcdcdcdcdcdcdcdd5d5d5d5d5d5d5d5dedede</span>
<span class="s">dededededee6e6e6e6e6e6e6e6eeeeeeeeeeeeeeeef6f6f6f6f6f6f6f6b98ac5</span>
<span class="s">ca0000012c49444154789c6360e7169150d230b475f7098d4ccc28a96ced9e32</span>
<span class="s">63c1da2d7b8e9fb97af3d1fb8f3f18e8a0808953544a4dd7c4c2c9233c2621bf</span>
<span class="s">b4aab17fdacce5ab36ee3a72eafaad87efbefea68702362e7159652d031b07cf</span>
<span class="s">c0b8a4cce28aa68e89f316aedfb4ffd0b92bf79fbcfcfe931e0a183904e55435</span>
<span class="s">8decdcbcc22292b3caaadb7b27cc5db67af3be63e72fdf78fce2d31f7a2860e5</span>
<span class="s">119356d037b374f10e8a4fc92eaa6fee99347fc9caad7b0f9ebd74f7c1db2fbf</span>
<span class="s">e8a180995f484645dbdccad12f38363dafbcb6a573faeca5ebb6ed3e7ce2c29d</span>
<span class="s">e76fbefda38702063e0149751d537b67ff80e8d4dcc29a86bea97316add9b0e3</span>
<span class="s">c0e96bf79ebdfafc971e0a587885e515f58cad5d7d43a2d2720aeadaba26cf5a</span>
<span class="s">bc62fbcea3272fde7efafac37f3a28000087c0fe101bc2f85f0000000049454e</span>
<span class="s">44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;tbbn1g04&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020040000000093e1c8</span>
<span class="s">290000000467414d41000186a031e8965f0000000274524e530007e8f7589b00</span>
<span class="s">000002624b47440000aa8d23320000013e49444154789c55d1cd4b024118c7f1</span>
<span class="s">efbe6419045b6a48a72d352808b435284f9187ae9b098627a1573a19945beba5</span>
<span class="s">e8129e8222af11d81e3a4545742de8ef6af6d5762e0fbf0fc33c33f36085cb76</span>
<span class="s">bc4204778771b867260683ee57e13f0c922df5c719c2b3b6c6c25b2382cea4b9</span>
<span class="s">9f7d4f244370746ac71f4ca88e0f173a6496749af47de8e44ba8f3bf9bdfa98a</span>
<span class="s">0faf857a7dd95c7dc8d7c67c782c99727997f41eb2e3c1e554152465bb00fe8e</span>
<span class="s">b692d190b718d159f4c0a45c4435915a243c58a7a4312a7a57913f05747594c6</span>
<span class="s">46169866c57101e4d4ce4d511423119c419183a3530cc63db88559ae28e7342a</span>
<span class="s">1e9c8122b71139b8872d6e913153224bc1f35b60e4445bd4004e20ed6682c759</span>
<span class="s">1d9873b3da0fbf50137dc5c9bde84fdb2ec8bde1189e0448b63584735993c209</span>
<span class="s">7a601bd2710caceba6158797285b7f2084a2f82c57c01a0000000049454e44ae</span>
<span class="s">426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;tbrn2c08&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d4948445200000020000000200802000000fc18ed</span>
<span class="s">a30000000467414d41000186a031e8965f0000000674524e53007f007f007f8a</span>
<span class="s">33334f00000006624b474400ff0000000033277cf3000004d649444154789cad</span>
<span class="s">965f68537714c73fd912d640235e692f34d0406fa0c1663481045ab060065514</span>
<span class="s">56660a295831607df0a1488715167060840a1614e6431e9cb34fd2c00a762c85</span>
<span class="s">f6a10f816650c13b0cf40612e1822ddc4863bd628a8924d23d6464f9d3665dd9</span>
<span class="s">f7e977ce3dbff3cd3939bfdfef6bb87dfb364782dbed065ebe7cd93acc78b4ec</span>
<span class="s">a228debd7bb7bfbfbfbbbbfb7f261045311a8d261209405194274f9ea4d3e916</span>
<span class="s">f15f1c3eb5dd6e4fa5fecce526239184a2b0b8486f6f617171b1f5ae4311381c</span>
<span class="s">8e57af5e5dbd7a351088150a78bd389d44222c2f93cdfe66b7db8f4ee07038b6</span>
<span class="s">b6b6bebf766d7e7e7e60a06432313b4ba984c3c1c4049a46b95c5a58583822c1</span>
<span class="s">dbb76f27272733d1b9df853c3030c0f232562b9108cf9eb1b888d7cbf030abab</span>
<span class="s">31abd5fa1f08dc6ef7e7cf9f1f3f7e1c8944745d4f1400c62c001313acad21cb</span>
<span class="s">b8dd2c2c603271eb1640341aad4c6d331aa7e8c48913a150a861307ecc11e964</span>
<span class="s">74899919bc5e14e56fffc404f1388502f178dceff7ef4bf0a5cfe7abb533998c</span>
<span class="s">e5f9ea2f1dd88c180d64cb94412df3dd57e83a6b3b3c7a84c98420100c72fd3a</span>
<span class="s">636348bae726379fe69e8e8d8dbd79f3a6558b0607079796965256479b918085</span>
<span class="s">7b02db12712b6181950233023f3f647494ee6e2e5ea45864cce5b8a7fe3acffc</span>
<span class="s">3aebb22c2bd5d20e22d0757d7b7bbbbdbd3d94a313bed1b0aa3cd069838b163a</span>
<span class="s">8d4c59585f677292d0b84d9a995bd337def3fe6bbe5e6001989b9b6bfe27ea08</span>
<span class="s">36373781542ab56573248b4c5bc843ac4048c7ab21aa24ca00534c25482828a3</span>
<span class="s">8c9ee67475bbaaaab22cb722c8e57240a150301a8d219de94e44534d7d90e885</span>
<span class="s">87acb0e2c4f9800731629b6c5ee14a35a6b9887d2a0032994cb9cf15dbe59650</span>
<span class="s">ff7b46a04c9a749e7cc5112214266cc65c31354d5b5d5d3d90209bcd5616a552</span>
<span class="s">a95c2e87f2a659bd9ee01c2cd73964e438f129a6aa9e582c363838b80f81d7eb</span>
<span class="s">5555b56a2a8ad2d9d7affd0409f8015c208013fea00177b873831b0282c964f2</span>
<span class="s">783c1e8fa7582cee5f81a669b5e6eeeeaee58e8559b0c233d8843c7c0b963a82</span>
<span class="s">34e94b5cb2396d7d7d7db22c8ba258fb0afd43f0e2c58b919191ba9de9b4d425</span>
<span class="s">118329b0c3323c8709d02041b52b4ea7f39de75d2a934a2693c0a953a76a93d4</span>
<span class="s">5d157ebf7f6565a5542a553df97c5e10045dd731c130b86113cc300cbd489224</span>
<span class="s">08422a952a140a95788fc763b1d41558d7a2d7af5f5fb870a1d6a3aaaacd6603</span>
<span class="s">18802da84c59015bd2e6897b745d9765b99a1df0f97c0daf74e36deaf7fbcd66</span>
<span class="s">73ad2797cb89a2c839880188a2e8743a8bc5a22ccbba5e376466b3b9bdbdbd21</span>
<span class="s">6123413a9d0e0402b51e4dd3bababa788eb022b85caeb6b6364551b6b7b76942</span>
<span class="s">43f7f727007a7a7a04a1ee8065b3595fde2768423299ac1ec6669c3973e65004</span>
<span class="s">c0f8f878ad69341a33994ced2969c0d0d0502412f9f8f163f3a7fd654b474787</span>
<span class="s">288ad53e74757535df6215b85cae60302849d2410aecc037f9f2e5cbd5b5c160</span>
<span class="s">680eb0dbede170381c0e7ff8f0a185be3b906068684892a4ca7a6f6faff69328</span>
<span class="s">8ad3d3d3f7efdfdfdbdbfb57e96868a14d0d0643381c96242997cbe5f3794010</span>
<span class="s">84603078fcf8f1d6496bd14a3aba5c2ea7d369341a5555b5582c8140e0fcf9f3</span>
<span class="s">1b1b1b87cf4eeb0a8063c78e45a3d19e9e1ebfdfdf5a831e844655d18093274f</span>
<span class="s">9e3d7bf6d3a74f3b3b3b47c80efc05ff7af28fefb70d9b0000000049454e44ae</span>
<span class="s">426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
    <span class="s">&#39;basn6a16&#39;</span><span class="p">:</span> <span class="n">_dehex</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">89504e470d0a1a0a0000000d494844520000002000000020100600000023eaa6</span>
<span class="s">b70000000467414d41000186a031e8965f00000d2249444154789cdd995f6c1c</span>
<span class="s">d775c67ff38fb34b724d2ee55a8e4b04a0ac87049100cab4dbd8c6528902cb4d</span>
<span class="s">10881620592e52d4325ac0905bc98a94025e71fd622cb5065ac98a0c283050c0</span>
<span class="s">728a00b6e542a1d126885cd3298928891d9a0444037e904434951d4b90b84b2f</span>
<span class="s">c9dde1fcebc33977a95555348f411e16dfce9d3b77ee77eebde77ce78c95a669</span>
<span class="s">0ad07c17009a13edd898b87dfb1fcb7d2b4d1bff217f33df80deb1e6267df0ff</span>
<span class="s">c1e6e6dfafdf1f5a7fd30f9aef66b6d546dd355bf02c40662e3307f9725a96c6</span>
<span class="s">744c3031f83782f171c148dbc3bf1774f5dad1e79d6f095a3f54d4fbec5234ef</span>
<span class="s">d9a2f8d73afe4f14f57ef4f42def7b44f19060f06b45bddf1c5534d77fd922be</span>
<span class="s">2973a15a82e648661c6e3240aa3612ead952b604bde57458894f29deaf133bac</span>
<span class="s">13d2766f5227a4a3b8cf08da7adfd6fbd6bd8a4fe9dbb43d35e3dfa3f844fbf8</span>
<span class="s">9119bf4f7144094fb56333abf8a86063ca106f94b3a3b512343765e60082097f</span>
<span class="s">1bb86ba72439a653519b09f5cee1ce61c897d37eedf5553580ae60f4af8af33a</span>
<span class="s">b14fd400b6a0f34535c0434afc0b3a9f07147527a5fa7ca218ff56c74d74dc3f</span>
<span class="s">155cfd3325fc278acf2ae1cb4a539f5f9937c457263b0bd51234c732a300cdd1</span>
<span class="s">cc1840f0aaff54db0e4874ed5a9b5d6d27d4bb36746d80de72baa877ff4b275a</span>
<span class="s">d7895ed1897ea4139b5143fcbb1a62560da1ed9662aaed895ec78a91c18795b8</span>
<span class="s">5e07ab4af8ba128e95e682e0728bf8f2e5ae815a091a53d902ac1920d8e05f06</span>
<span class="s">589de8d8d66680789f4e454fb9d9ec66cd857af796ee2d902fa73fd5bba775a2</span>
<span class="s">153580ae44705ed0d37647d15697cb8f14bfa3e3e8fdf8031d47af571503357c</span>
<span class="s">f30d25acedcbbf135c9a35c49766ba07ab255859e8ec03684e66860182dff8f7</span>
<span class="s">0304bff6ff1c20fc81b7afdd00a71475539a536e36bb5973a19e3b923b02bde5</span>
<span class="s">e4efd4003ac170eb2d13fe274157afedbd82d6fb3a9a1e85e4551d47cf7078f8</span>
<span class="s">9671fe4289ebf5f2bf08d63f37c4eb4773c55a0996efeefa0ca011671d8060ca</span>
<span class="s">2f0004c7fcc300e166ef0240f825efe3361f106d57d423d0723f7acacd66376b</span>
<span class="s">2ed47b7a7a7a205f4ef4ac4691e0aad9aa0d41cf13741c3580a506487574ddca</span>
<span class="s">61a8c403c1863ebfbcac3475168b2de28b8b3d77544bb05ce92a02aceced3c0d</span>
<span class="s">d0cc65ea371b201cf1c601c24dde1c4078cedbdeb60322f50126a019bf6edc9b</span>
<span class="s">39e566b39b3517eaf97c3e0fbde5e4491d45bd74537145d155b476aa0176e868</span>
<span class="s">c6abebf30dbd5e525c54ac8e18e2d56abeb756827a3d970358a97416019a6f64</span>
<span class="s">f60004fdfe1580d5c98e618070cc1b05887eee7e0d209a70db7d8063029889b4</span>
<span class="s">c620ead78d7b33a7dc6c76b3e6427ddddbebde867c393aa7845e5403e8ca794a</span>
<span class="s">d0d6fb897af5f03525fe5782f5e7046bdaef468bf88d1debc6ab25583cd17310</span>
<span class="s">6079b9ab0ba059c914018245bf076075b5a303200c3c1f209a733701444fbbaf</span>
<span class="s">00c4134ebb016c5d0b23614c243701cdf875e3decce9349bddacb9505fbf7dfd</span>
<span class="s">76e82d87736a00f5d2b5ffd4b7dce2719a4d25ae717ee153c1abef18e257cfad</span>
<span class="s">7fa45682da48ef38c052b53b0fd06864b300c151ff08c0ea431de701a287dd5f</span>
<span class="s">004497dc7b01a253ee3e80b8c7f91c20f967fb6fdb7c80ada7d8683723614c24</span>
<span class="s">3701cdf875e3decc29379bddacb950ef3fd47f08f2e5a61ea4aa2a3eb757cd55</span>
<span class="s">13345efcfa59c12b2f19e2578ef77fb75a82854ffbee01a83f977b11a031931d</span>
<span class="s">040802df07082b5e11207cc17b1e209a770700e2df0a83e409fb7580f827c230</span>
<span class="s">99b06fd901fb058d6835dacd481813c94d40337eddb83773cacd66376b2ed437</span>
<span class="s">bebcf165e82d2f4e4beb7f3fa6e652c2d7ee10bc78c010bfb87fe3c95a09ae9f</span>
<span class="s">bd732740bd2fb700d0f865f64180e059ff044018ca0ca28a5b04883f701e0088</span>
<span class="s">bfec7c0c909cb71f0448c6ec518074b375012079d9dedf66004bcfbc51eb2dd1</span>
<span class="s">aadacd481813c94d40337eddb83773cacd66376b2ed487868686205fbe7c49ef</span>
<span class="s">5605a73f34c4a7a787eeab96e0da81bb4e022c15ba27019a5b339300e16bf286</span>
<span class="s">a8eae601e25866907cdf3e0890acb36f00245fb57f05904e59c300e92561946e</span>
<span class="s">b2e600d209ab7d07f04d458dfb46ad1bd16ab49b913026929b8066fcba716fe6</span>
<span class="s">949bcd6ed65ca8ef7e7cf7e3d05b7e7c8f217ee6cdddbb6a25a856f37980e0c7</span>
<span class="s">fe4e80a82623c48193014846ec7180f4acf518409aca0cd28a5504e03b32c374</span>
<span class="s">de1a00608a0240faaa327a4b19fe946fb6f90054dbb5f2333d022db56eb4966a</span>
<span class="s">3723614c243701cdf8f556bea8a7dc6c76b3e66bd46584ddbbcebc0990cf4b0f</span>
<span class="s">ff4070520c282338a7e26700ec725202b01e4bcf0258963c6f1d4d8f0030cb20</span>
<span class="s">805549c520930c03584fa522b676f11600ffc03fde3e1b3489a9c9054c9aa23b</span>
<span class="s">c08856a3dd8c843191dc0434e3d78d7b33a75c36fb993761f7ae5a69f72ef97f</span>
<span class="s">e6ad336fed7e1c60e8bee96980bbdebbb60da07b7069062033d9dc0ae03d296f</span>
<span class="s">70ab511ec071640676252902d833c916007b3e1900b0a6d2028035968e025861</span>
<span class="s">ea01581369fb11488c34d18cbc95989afccca42baad65ba2d5683723614c24d7</span>
<span class="s">8066fcbab8b7e96918baaf5aaa56219f975fb50a43f7c9bde90fa73f1c1a02d8</span>
<span class="s">78f2e27e803b77ca08b90519315b6fe400fc1392097a9eccc0ad444500e70199</span>
<span class="s">a1331f0f00d8934901c07e5d526ceb87c2d07e2579badd005a2b31a5089391b7</span>
<span class="s">1253358049535a6add8856dd0146c298482e01ede27ed878b256ba7600ee3a09</span>
<span class="s">c18fc1df09fe01084ec25defc1b56db0f1a4f4bd78e0e2818d2f0334e7330300</span>
<span class="s">7df7c888b917e50dd9c1c60c80efcb0cbc63e1f700bce7c31700dccbd1060027</span>
<span class="s">8add9b0de06c8e2f00d84962b7d7030e2a61538331b98051f92631bd253f336a</span>
<span class="s">dd8856a3dd44c25c390efddfad96ae9f853b77c25201ba27c533b8bdf28b6ad0</span>
<span class="s">3d084b33d2e7fa59099e9901b8f2d29597fa0f01848f78e70082117f1ca07b76</span>
<span class="s">6910209b9519f895a008d031bbba05c09d8f06005c5b18b8fba25300cea6780e</span>
<span class="s">c03e911c6ccf06d507b48a4fa606634a114609de929f9934c5a87511ad57cfc1</span>
<span class="s">fa476aa5854fa1ef1e3910b905686e85cc24c40138198915f133d2d6dc2a7dea</span>
<span class="s">7df2ccc2a752faf2cec1d577aebeb37e3b4034eeee0008dff3be0e6b923773b4</span>
<span class="s">7904c0ef9119767cb4fa1500ef1361e08e452500f71561e84cc4ed3e20fab6a2</span>
<span class="s">c905f40cb76a3026bf3319b91ac2e46792a6dcd801ebc6aba5da08f48ecb81c8</span>
<span class="s">bd088d5f42f6417191de93908c803d0e76199292b485af41b60e8d9c3c537f0e</span>
<span class="s">8211f0c7211a077707dc18b931b2ee6d80a4d7ae024491ebc24d4a708ff70680</span>
<span class="s">7f25e807e8785f1878e322d6ddaf453f0770ff2dfa769b01423dbbad72a391b6</span>
<span class="s">5a7c3235985629423372494cab55c8f7d64a8b27a0e7202c55a13b0f8d19c80e</span>
<span class="s">4ae9ca3f015115dc3ca467c17a4c7ee95970ab10e5a54ff0ac3cd39881ee5958</span>
<span class="s">1a84f03df0be0e492fd855a8d6aa35d10b4962dbb0a604a3d3ee5e80a8eee600</span>
<span class="s">a24977f8660378bf0bbf00e01d0a8fb7f980f04b8aa6ce6aca8d5a7533c52753</span>
<span class="s">839152c4e222f4dc512dd5eb90cbc981e8ea12cf90cd8a8bf47d89159e2741d3</span>
<span class="s">7124f65b96fcd254dae258fa84a13c13043246a32129574787e49eae2b49b86d</span>
<span class="s">c3e2e78b9ff7f4002415bb08907c66df0d103b4e0c104db90500ff70700c203a</span>
<span class="s">ee1e82dba4c3e16e256c0acca6ceaae9afd1f612d7eb472157ac95962bd05594</span>
<span class="s">7dd1598466053245088e827f44628657942a825b84e4fb601f84b4025611aca3</span>
<span class="s">901e01bb024911dc0a4445f08e41f83df02b10142173149ab71baf027611ea95</span>
<span class="s">7a257704201d14cd9af4d90b00f194530088cb4e09c0df1c5c0088f7393f6833</span>
<span class="s">c0aa3ac156655de3bca9b34ab9716906ba07aba5e5bba1eb3358d90b9da7c533</span>
<span class="s">64f6888bf47b60f521e8380fe10be03d2feac17900927560df40f4e48f805960</span>
<span class="s">50328d648bf4893f9067c217a0631656b7c898c122847bc07b03a2d3e0ee85e4</span>
<span class="s">33b0ef867450c4fad2ecd26cf7168074c0ba0c904cdac300c9cfec4701924df6</span>
<span class="s">1cdca61e10685c6f7d52d0caba1498972f43d740adb4b2009d7d7220b20e3473</span>
<span class="s">90a943d00ffe959bb6eac3e0fe42ea49ee00c45f06e76329b1dabf127d690d80</span>
<span class="s">5581b408f63c2403e0cc433c00ee658836803b0fd100747c04ab5f917704fd10</span>
<span class="s">d5c1cd41ec801343d207f602a403605d86e5f9e5f9ae0d00e994556833806685</span>
<span class="s">c931fb709b0f08b4e869bea5c827859549e82c544b8d29c816a0390999613920</span>
<span class="s">7e610d5727a16318c2003c1fa24be0de2b32caf92224e7c17e5004b6350c4c01</span>
<span class="s">05601218066b0ad28224e149019c086257ca315102de2712903bde97b8144d82</span>
<span class="s">3b2c6ac52d403c054e019249b087f53d0558995a99ea946c70cc927458b3c1ff</span>
<span class="s">550f30050df988d4284376b4566a8e416654cc921985e037e0df0fc131f00f4b</span>
<span class="s">acf0c6211c036f14a239703741740adc7da227edd7e56b833d0ae92549b4d357</span>
<span class="s">25dfb49ed2ff63908e6adf27d6d0dda7638d4154d2778daca17f58e61297c129</span>
<span class="s">41f233b01f5dc3740cac51688c35c6b22580f48224fee9b83502569a66b629f1</span>
<span class="s">09f3713473413e2666e7fe6f6c6efefdfafda1f56f6e06f93496d9d67cb7366a</span>
<span class="s">9964b6f92e64b689196ec6c604646fd3fe4771ff1bf03f65d8ecc3addbb5f300</span>
<span class="s">00000049454e44ae426082</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">test_suite</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PNG test image and write the file to stdout.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Below is a big stack of test image generators.</span>
    <span class="c"># They&#39;re all really tiny, so PEP 8 rules are suspended.</span>

    <span class="k">def</span> <span class="nf">test_gradient_horizontal_lr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">test_gradient_horizontal_rl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">test_gradient_vertical_tb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">test_gradient_vertical_bt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">test_radial_tl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_radial_center</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_radial_tl</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_radial_tr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_radial_tl</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_radial_bl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_radial_tl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_radial_br</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_radial_tl</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_h_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_h_4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_h_10</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_v_2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_v_4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_v_10</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_lr_10</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_stripe_rl_10</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_stripe</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_checker</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_checker_8</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_checker</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_checker_15</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">test_checker</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_zero</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">test_one</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">test_patterns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;GLR&#39;</span><span class="p">:</span> <span class="n">test_gradient_horizontal_lr</span><span class="p">,</span>
        <span class="s">&#39;GRL&#39;</span><span class="p">:</span> <span class="n">test_gradient_horizontal_rl</span><span class="p">,</span>
        <span class="s">&#39;GTB&#39;</span><span class="p">:</span> <span class="n">test_gradient_vertical_tb</span><span class="p">,</span>
        <span class="s">&#39;GBT&#39;</span><span class="p">:</span> <span class="n">test_gradient_vertical_bt</span><span class="p">,</span>
        <span class="s">&#39;RTL&#39;</span><span class="p">:</span> <span class="n">test_radial_tl</span><span class="p">,</span>
        <span class="s">&#39;RTR&#39;</span><span class="p">:</span> <span class="n">test_radial_tr</span><span class="p">,</span>
        <span class="s">&#39;RBL&#39;</span><span class="p">:</span> <span class="n">test_radial_bl</span><span class="p">,</span>
        <span class="s">&#39;RBR&#39;</span><span class="p">:</span> <span class="n">test_radial_br</span><span class="p">,</span>
        <span class="s">&#39;RCTR&#39;</span><span class="p">:</span> <span class="n">test_radial_center</span><span class="p">,</span>
        <span class="s">&#39;HS2&#39;</span><span class="p">:</span> <span class="n">test_stripe_h_2</span><span class="p">,</span>
        <span class="s">&#39;HS4&#39;</span><span class="p">:</span> <span class="n">test_stripe_h_4</span><span class="p">,</span>
        <span class="s">&#39;HS10&#39;</span><span class="p">:</span> <span class="n">test_stripe_h_10</span><span class="p">,</span>
        <span class="s">&#39;VS2&#39;</span><span class="p">:</span> <span class="n">test_stripe_v_2</span><span class="p">,</span>
        <span class="s">&#39;VS4&#39;</span><span class="p">:</span> <span class="n">test_stripe_v_4</span><span class="p">,</span>
        <span class="s">&#39;VS10&#39;</span><span class="p">:</span> <span class="n">test_stripe_v_10</span><span class="p">,</span>
        <span class="s">&#39;LRS&#39;</span><span class="p">:</span> <span class="n">test_stripe_lr_10</span><span class="p">,</span>
        <span class="s">&#39;RLS&#39;</span><span class="p">:</span> <span class="n">test_stripe_rl_10</span><span class="p">,</span>
        <span class="s">&#39;CK8&#39;</span><span class="p">:</span> <span class="n">test_checker_8</span><span class="p">,</span>
        <span class="s">&#39;CK15&#39;</span><span class="p">:</span> <span class="n">test_checker_15</span><span class="p">,</span>
        <span class="s">&#39;ZERO&#39;</span><span class="p">:</span> <span class="n">test_zero</span><span class="p">,</span>
        <span class="s">&#39;ONE&#39;</span><span class="p">:</span> <span class="n">test_one</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_pattern</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">bitdepth</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a single plane (monochrome) test pattern.  Returns a</span>
<span class="sd">        flat row flat pixel array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">bitdepth</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">maxval</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="n">pfun</span> <span class="o">=</span> <span class="n">test_patterns</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="n">fy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">fh</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pfun</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">fw</span><span class="p">,</span> <span class="n">fy</span><span class="p">)</span> <span class="o">*</span> <span class="n">maxval</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">a</span>

    <span class="k">def</span> <span class="nf">test_rgba</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">bitdepth</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                  <span class="n">red</span><span class="o">=</span><span class="s">&quot;GTB&quot;</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="s">&quot;GLR&quot;</span><span class="p">,</span> <span class="n">blue</span><span class="o">=</span><span class="s">&quot;RTL&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a test image.  Each channel is generated from the</span>
<span class="sd">        specified pattern; any channel apart from red can be set to</span>
<span class="sd">        None, which will cause it not to be in the image.  It</span>
<span class="sd">        is possible to create all PNG channel types (L, RGB, LA, RGBA),</span>
<span class="sd">        as well as non PNG channel types (RGA, and so on).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">test_pattern</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">bitdepth</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span>
        <span class="n">psize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">channel</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">test_pattern</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">bitdepth</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">interleave_planes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">psize</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">pngsuite_image</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a test image by reading an internal copy of the files</span>
<span class="sd">        from the PngSuite.  Returned in flat row flat pixel format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_pngsuite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;cannot find PngSuite file </span><span class="si">%s</span><span class="s"> (use -L for a list)&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">_pngsuite</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">w</span> <span class="o">==</span> <span class="n">h</span>
        <span class="c"># LAn for n &lt; 8 is a special case for which we need to rescale</span>
        <span class="c"># the data.</span>
        <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;greyscale&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="nb">map</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">__mul__</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="n">pixels</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">arraycode</span> <span class="o">=</span> <span class="s">&#39;BH&#39;</span><span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">array</span><span class="p">(</span><span class="n">arraycode</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">pixels</span><span class="p">)),</span> <span class="n">meta</span>

    <span class="c"># The body of test_suite()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_size</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_size</span>
    <span class="n">options</span><span class="o">.</span><span class="n">bitdepth</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_depth</span>
    <span class="n">options</span><span class="o">.</span><span class="n">greyscale</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">test_black</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_red</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;red&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_red</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_green</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_green</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_blue</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;blue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_blue</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_alpha</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_alpha</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">greyscale</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test_red</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">test_green</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">test_blue</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cannot specify colours (R, G, B) when greyscale image (black channel, K) is specified&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;red&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">test_black</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;blue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">options</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">test_alpha</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">test_rgba</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">pngsuite_image</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">,</span> <span class="s">&#39;alpha&#39;</span><span class="p">,</span> <span class="s">&#39;greyscale&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
                    <span class="n">bitdepth</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">bitdepth</span><span class="p">,</span>
                    <span class="n">transparent</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">transparent</span><span class="p">,</span>
                    <span class="n">background</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">background</span><span class="p">,</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="n">greyscale</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">greyscale</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">compression</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">compression</span><span class="p">,</span>
                    <span class="n">interlace</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">interlace</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">pixels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_pam_header</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read (the rest of a) PAM header.  `infile` should be positioned</span>
<span class="sd">    immediately after the initial &#39;P7&#39; line (at the beginning of the</span>
<span class="sd">    second line).  Returns are as for `read_pnm_header`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Unlike PBM, PGM, and PPM, we can read the header a line at a time.</span>
    <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s">&#39;ENDHDR&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">(</span><span class="s">&#39;PAM ended prematurely&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;WIDTH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span>
                <span class="s">&#39;HEIGHT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span>
                <span class="s">&#39;DEPTH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">or</span>
                <span class="s">&#39;MAXVAL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;PAM file must specify WIDTH, HEIGHT, DEPTH, and MAXVAL&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;WIDTH&#39;</span><span class="p">])</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;HEIGHT&#39;</span><span class="p">])</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DEPTH&#39;</span><span class="p">])</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;MAXVAL&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span>
                <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span>
                <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span>
                <span class="n">maxval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span>
            <span class="s">&#39;WIDTH, HEIGHT, DEPTH, MAXVAL must all be positive integers&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;P7&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">maxval</span>


<span class="k">def</span> <span class="nf">read_pnm_header</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;P5&#39;</span><span class="p">,</span> <span class="s">&#39;P6&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a PNM header, returning (format,width,height,depth,maxval).</span>
<span class="sd">    `width` and `height` are in pixels.  `depth` is the number of</span>
<span class="sd">    channels in the image; for PBM and PGM it is synthesized as 1, for</span>
<span class="sd">    PPM as 3; for PAM images it is read from the header.  `maxval` is</span>
<span class="sd">    synthesized (as 1) for PBM images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Generally, see http://netpbm.sourceforge.net/doc/ppm.html</span>
    <span class="c"># and http://netpbm.sourceforge.net/doc/pam.html</span>

    <span class="c"># Technically &#39;P7&#39; must be followed by a newline, so by using</span>
    <span class="c"># rstrip() we are being liberal in what we accept.  I think this</span>
    <span class="c"># is acceptable.</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;file format </span><span class="si">%s</span><span class="s"> not supported&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;P7&#39;</span><span class="p">:</span>
        <span class="c"># PAM header parsing is completely different.</span>
        <span class="k">return</span> <span class="n">read_pam_header</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="c"># Expected number of tokens in header (3 for P4, 4 for P6)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">pbm</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;P1&#39;</span><span class="p">,</span> <span class="s">&#39;P4&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">pbm</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">]</span>

    <span class="c"># We have to read the rest of the header byte by byte because the</span>
    <span class="c"># final whitespace character (immediately following the MAXVAL in</span>
    <span class="c"># the case of P6) may not be a newline.  Of course all PNM files in</span>
    <span class="c"># the wild use a newline at this point, so it&#39;s tempting to use</span>
    <span class="c"># readline; but it would be wrong.</span>
    <span class="k">def</span> <span class="nf">getc</span><span class="p">():</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;premature EOF reading PNM header&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c"># Skip whitespace that precedes a token.</span>
        <span class="k">while</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">()</span>
        <span class="c"># Skip comments.</span>
        <span class="k">while</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;</span><span class="se">\n\r</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;unexpected character </span><span class="si">%s</span><span class="s"> found in header&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
        <span class="c"># According to the specification it is legal to have comments</span>
        <span class="c"># that appear in the middle of a token.</span>
        <span class="c"># This is bonkers; I&#39;ve never seen it; and it&#39;s a bit awkward to</span>
        <span class="c"># code good lexers in Python (no goto).  So we break on such</span>
        <span class="c"># cases.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">token</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">()</span>
        <span class="c"># Slight hack.  All &quot;tokens&quot; are decimal integers, so convert</span>
        <span class="c"># them here.</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c"># Skip comments (again)</span>
    <span class="k">while</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;</span><span class="se">\n\r</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">getc</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;expected header to end with whitespace, not </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">pbm</span><span class="p">:</span>
        <span class="c"># synthesize a MAXVAL</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;P6&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">depth</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">write_pnm</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a Netpbm PNM/PAM file.&quot;&quot;&quot;</span>

    <span class="n">bitdepth</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;bitdepth&#39;</span><span class="p">]</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">bitdepth</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c"># Rudely, the number of image planes can be used to determine</span>
    <span class="c"># whether we are L (PGM), LA (PAM), RGB (PPM), or RGBA (PAM).</span>
    <span class="n">planes</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s">&#39;planes&#39;</span><span class="p">]</span>
    <span class="c"># Can be an assert as long as we assume that pixels and meta came</span>
    <span class="c"># from a PNG file.</span>
    <span class="k">assert</span> <span class="n">planes</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">planes</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">planes</span><span class="p">:</span>
            <span class="c"># PGM</span>
            <span class="c"># Could generate PBM if maxval is 1, but we don&#39;t (for one</span>
            <span class="c"># thing, we&#39;d have to convert the data, not just blat it</span>
            <span class="c"># out).</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;P5&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># PPM</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;P6&#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">maxval</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">planes</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="c"># PAM</span>
        <span class="c"># See http://netpbm.sourceforge.net/doc/pam.html</span>
        <span class="k">if</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">planes</span><span class="p">:</span>
            <span class="n">tupltype</span> <span class="o">=</span> <span class="s">&#39;GRAYSCALE_ALPHA&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tupltype</span> <span class="o">=</span> <span class="s">&#39;RGB_ALPHA&#39;</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;P7</span><span class="se">\n</span><span class="s">WIDTH </span><span class="si">%d</span><span class="se">\n</span><span class="s">HEIGHT </span><span class="si">%d</span><span class="se">\n</span><span class="s">DEPTH </span><span class="si">%d</span><span class="se">\n</span><span class="s">MAXVAL </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span>
                   <span class="s">&#39;TUPLTYPE </span><span class="si">%s</span><span class="se">\n</span><span class="s">ENDHDR</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="n">tupltype</span><span class="p">))</span>
    <span class="c"># Values per row</span>
    <span class="n">vpr</span> <span class="o">=</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">width</span>
    <span class="c"># struct format</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;&gt;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">vpr</span>
    <span class="k">if</span> <span class="n">maxval</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">+=</span> <span class="s">&#39;H&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">+=</span> <span class="s">&#39;B&#39;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">row</span><span class="p">))</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">color_triple</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a command line colour value to a RGB triple of integers.</span>
<span class="sd">    FIXME: Somewhere we need support for greyscale backgrounds etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">color</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">color</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">color</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">13</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the PNG encoder with options from the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Parse command line arguments</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">version</span> <span class="o">=</span> <span class="s">&#39;%prog &#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;( ?\$|URL: |Rev:)&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_usage</span><span class="p">(</span><span class="s">&quot;%prog [options] [imagefile]&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="s">&#39;--read-png&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Read PNG, write PNM&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">,</span> <span class="s">&quot;--interlace&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;create an interlaced PNG file (Adam7)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-t&quot;</span><span class="p">,</span> <span class="s">&quot;--transparent&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;color&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;mark the specified colour (#RRGGBB) as transparent&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="s">&quot;--background&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;color&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;save the specified background colour&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="s">&quot;--alpha&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;pgmfile&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;alpha channel transparency (RGBA)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-g&quot;</span><span class="p">,</span> <span class="s">&quot;--gamma&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;float&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;value&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;save the specified gamma value&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;--compression&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;level&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;zlib compression level (0-9)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-T&quot;</span><span class="p">,</span> <span class="s">&quot;--test&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;create a test image (a named PngSuite image if an argument is supplied)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-L&#39;</span><span class="p">,</span> <span class="s">&#39;--list&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;print list of named test images&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-R&quot;</span><span class="p">,</span> <span class="s">&quot;--test-red&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;pattern&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;test pattern for the red image layer&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-G&quot;</span><span class="p">,</span> <span class="s">&quot;--test-green&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;pattern&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;test pattern for the green image layer&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-B&quot;</span><span class="p">,</span> <span class="s">&quot;--test-blue&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;pattern&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;test pattern for the blue image layer&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-A&quot;</span><span class="p">,</span> <span class="s">&quot;--test-alpha&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;pattern&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;test pattern for the alpha image layer&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-K&quot;</span><span class="p">,</span> <span class="s">&quot;--test-black&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;pattern&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;test pattern for greyscale image&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="s">&quot;--test-depth&quot;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;NBITS&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;create test PNGs that are NBITS bits per channel&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-S&quot;</span><span class="p">,</span> <span class="s">&quot;--test-size&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;size&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;width and height of the test image&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c"># Convert options</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">transparent</span> <span class="o">=</span> <span class="n">color_triple</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">transparent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">color_triple</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">background</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_pngsuite</span><span class="p">)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">name</span>
        <span class="k">return</span>

    <span class="c"># Run regression tests</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">test_suite</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c"># Prepare input and output files</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">infilename</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">infilename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">infilename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;more than one input file&quot;</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">read_png</span><span class="p">:</span>
        <span class="c"># Encode PNG to PPM</span>
        <span class="n">png</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
        <span class="n">write_pnm</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Encode PNM to PNG</span>
        <span class="n">format</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> \
            <span class="n">read_pnm_header</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;P5&#39;</span><span class="p">,</span> <span class="s">&#39;P6&#39;</span><span class="p">,</span> <span class="s">&#39;P7&#39;</span><span class="p">))</span>
        <span class="c"># When it comes to the variety of input formats, we do something</span>
        <span class="c"># rather rude.  Observe that L, LA, RGB, RGBA are the 4 colour</span>
        <span class="c"># types supported by PNG and that they correspond to 1, 2, 3, 4</span>
        <span class="c"># channels respectively.  So we use the number of channels in</span>
        <span class="c"># the source image to determine which one we have.  We do not</span>
        <span class="c"># care about TUPLTYPE.</span>
        <span class="n">greyscale</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">2</span>
        <span class="n">pamalpha</span> <span class="o">=</span> <span class="n">depth</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">supported</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mi</span> <span class="o">=</span> <span class="n">supported</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&#39;your maxval (</span><span class="si">%s</span><span class="s">) not in supported list </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">maxval</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">supported</span><span class="p">)))</span>
        <span class="n">bitdepth</span> <span class="o">=</span> <span class="n">mi</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                        <span class="n">greyscale</span><span class="o">=</span><span class="n">greyscale</span><span class="p">,</span>
                        <span class="n">bitdepth</span><span class="o">=</span><span class="n">bitdepth</span><span class="p">,</span>
                        <span class="n">interlace</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">interlace</span><span class="p">,</span>
                        <span class="n">transparent</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">transparent</span><span class="p">,</span>
                        <span class="n">background</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">background</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">pamalpha</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">alpha</span><span class="p">),</span>
                        <span class="n">gamma</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                        <span class="n">compression</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">alpha</span><span class="p">:</span>
            <span class="n">pgmfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">format</span><span class="p">,</span> <span class="n">awidth</span><span class="p">,</span> <span class="n">aheight</span><span class="p">,</span> <span class="n">adepth</span><span class="p">,</span> <span class="n">amaxval</span> <span class="o">=</span> \
                <span class="n">read_pnm_header</span><span class="p">(</span><span class="n">pgmfile</span><span class="p">,</span> <span class="s">&#39;P5&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">amaxval</span> <span class="o">!=</span> <span class="s">&#39;255&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s">&#39;maxval </span><span class="si">%s</span><span class="s"> not supported for alpha channel&#39;</span> <span class="o">%</span> <span class="n">amaxval</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">awidth</span><span class="p">,</span> <span class="n">aheight</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;alpha channel image size mismatch&quot;</span>
                                 <span class="s">&quot; (</span><span class="si">%s</span><span class="s"> has </span><span class="si">%s</span><span class="s">x</span><span class="si">%s</span><span class="s"> but </span><span class="si">%s</span><span class="s"> has </span><span class="si">%s</span><span class="s">x</span><span class="si">%s</span><span class="s">)&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">infilename</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                                    <span class="n">options</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">awidth</span><span class="p">,</span> <span class="n">aheight</span><span class="p">))</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">convert_ppm_and_pgm</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">pgmfile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">convert_pnm</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">e</span>
</pre></div>

                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row footer-relbar">
<div id="navbar-related" class=" related navbar navbar-default" role="navigation" aria-label="related navigation">
  <div class="navbar-inner">
    <ul class="nav navbar-nav ">
        <li><a href="../index.html">MCEdit-Unified v1.5.6.0 documentation</a></li>
    </ul>
<ul class="nav navbar-nav pull-right hidden-xs hidden-sm">
      
        <li><a href="../py-modindex.html" title="Python Module Index" >modules</a></li>
        <li><a href="../genindex.html" title="General Index" >index</a></li>
        <li><a href="index.html" >Module code</a></li>
        <li><a href="#">top</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer role="contentinfo">
          &copy; Copyright 2010-2014 David Rio Vierra (Codewarrior0). 2014-2016 MCEdit-Unified Team and all of the contributers. All Rights Reserved to their respective ownership..
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>